{% extends 'base.html' %}
{% block content %}
{% load static %}
<div class="container-fluid py-2">
  <div class="row">
    <div class="ms-3">
      <h3 class="mb-0 h4 font-weight-bolder">Détail de la vente</h3>
      <p class="mb-4">{{ vente.ecole.nom }} - {{ vente.annee_scolaire }}</p>
    </div>

    <!-- Messages Django -->
    {% if messages %}
      <div class="col-12 mb-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
            <span class="alert-icon align-middle">
              <i class="material-symbols-rounded">info</i>
            </span>
            <span class="alert-text text-white">{{ message }}</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Informations générales -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header pb-0">
            <h6 class="text-dark font-weight-bolder">Informations générales</h6>
          </div>
          <div class="card-body">
            <p><strong>École :</strong> {{ vente.ecole.nom }}</p>
            <p><strong>Année scolaire :</strong> {{ vente.annee_scolaire }}</p>
            <p><strong>Date de création :</strong> {{ vente.created_at|date:"d/m/Y H:i" }}</p>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header pb-0">
            <h6 class="text-dark font-weight-bolder">Résumé financier</h6>
          </div>
          <div class="card-body">
            <p><strong>Montant total :</strong> {{ montant_total|floatformat:0 }} F</p>
            <p><strong>Montant payé :</strong> {{ montant_paye|floatformat:0 }} F</p>
            <p><strong>Montant restant :</strong> 
              <span class="{% if montant_restant <= 0 %}text-success{% else %}text-danger{% endif %} font-weight-bolder">
                {{ montant_restant|floatformat:0 }} F
              </span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Articles vendus -->
    <!-- Articles par session d'ajout -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header pb-0">
            <h6 class="text-dark font-weight-bolder">
              <i class="material-symbols-rounded me-2">schedule</i>
              Historique des ajouts d'articles
            </h6>
            <p class="text-sm mb-0">Articles groupés par moment d'ajout à la facture</p>
          </div>
          <div class="card-body">
            {% if sessions %}
              {% for session in sessions %}
                <div class="session-group mb-4 {% if not forloop.last %}border-bottom pb-3{% endif %}">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                      <h6 class="mb-1 text-dark">
                        <i class="material-symbols-rounded me-1">shopping_cart</i>
                        Session #{{ forloop.counter }}
                      </h6>
                      <small class="text-muted">
                        <i class="material-symbols-rounded me-1" style="font-size: 14px;">schedule</i>
                        {{ session.date_session|date:"d/m/Y à H:i" }}
                      </small>
                    </div>
                    <div class="text-end">
                      <div class="badge bg-gradient-primary">{{ session.montant_total|floatformat:0 }} F</div>
                      <div class="text-xs text-muted">{{ session.nombre_articles }} article{{ session.nombre_articles|pluralize }}</div>
                    </div>
                  </div>
                  
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Cahier</th>
                          <th class="text-center">Quantité</th>
                          <th class="text-end">Prix unitaire</th>
                          <th class="text-end">Montant</th>
                          <th class="text-center">Heure d'ajout</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for ligne in session.lignes %}
                        <tr>
                          <td>{{ ligne.cahier.titre }}</td>
                          <td class="text-center">{{ ligne.quantite }}</td>
                          <td class="text-end">{{ ligne.cahier.prix|floatformat:0 }} F</td>
                          <td class="text-end">{{ ligne.montant|floatformat:0 }} F</td>
                          <td class="text-center">
                            <small class="text-muted">{{ ligne.date_ajout|date:"H:i:s" }}</small>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="text-center py-4">
                <i class="material-symbols-rounded text-muted" style="font-size: 48px;">inventory_2</i>
                <p class="text-muted mt-2">Aucun article dans cette vente</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Articles par type (vue classique) -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header pb-0">
            <h6 class="text-dark font-weight-bolder">
              <i class="material-symbols-rounded me-2">list_alt</i>
              Articles par type
            </h6>
            <p class="text-sm mb-0">Vue groupée par type de cahier</p>
          </div>
          <div class="card-body">
            {% if ligne_ventes %}
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Type de cahier</th>
                      <th class="text-center">Quantité totale</th>
                      <th class="text-end">Prix unitaire</th>
                      <th class="text-end">Montant total</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for ligne in ligne_ventes %}
                    <tr>
                      <td>{{ ligne.cahier.titre }}</td>
                      <td class="text-center">{{ ligne.quantite_totale }}</td>
                      <td class="text-end">{{ ligne.cahier.prix|floatformat:0 }} F</td>
                      <td class="text-end">{{ ligne.montant_total|floatformat:0 }} F</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-center py-4">
                <i class="material-symbols-rounded text-muted" style="font-size: 48px;">inventory_2</i>
                <p class="text-muted mt-2">Aucun article dans cette vente</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>    <!-- Paiements -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header pb-0">
            <div class="d-flex justify-content-between">
              <h6 class="text-dark font-weight-bolder">Historique des paiements</h6>
              <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#paiementModal" 
                      data-vente-id="{{ vente.id }}" 
                      data-montant-total="{{ montant_total }}"
                      data-montant-paye="{{ montant_paye }}"
                      data-montant-restant="{{ montant_restant }}"
                      data-ecole-nom="{{ vente.ecole.nom }}"
                      data-annee="{{ vente.annee_scolaire }}"
                      data-dettes-autres="[]"
                      data-total-dettes-autres="0">
                <i class="material-symbols-rounded">add</i> Ajouter un paiement
              </button>
            </div>
          </div>
          <div class="card-body">
            {% if paiements %}
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Tranche</th>
                    <th>Montant</th>
                  </tr>
                </thead>
                <tbody>
                  {% for paiement in paiements %}
                  <tr>
                    <td class="border">{{ paiement.date_paiement|date:"d/m/Y" }}</td>
                    <td class="border">Tranche {{ paiement.numero_tranche }}</td>
                    <td class="border">{{ paiement.montant|floatformat:0 }} F</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p class="text-muted">Aucun paiement enregistré</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Autres ventes de la même école -->
    {% if related_groups %}
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header pb-0">
            <h6 class="text-dark font-weight-bolder">Autres ventes ({{ vente.ecole.nom }})</h6>
          </div>
          <div class="card-body">
            {% for date, ventes_groupe in related_groups.items %}
            <div class="mb-3">
              <h6 class="text-sm text-muted">{{ date }}</h6>
              {% for v in ventes_groupe %}
              <div class="border rounded p-2 mb-2">
                <div class="d-flex justify-content-between">
                  <span>Vente {{ v.id|slice:":8" }}... - {{ v.annee_scolaire }}</span>
                  <a href="{% url 'vente_detail' v.id %}" class="btn btn-sm btn-outline-primary">Voir</a>
                </div>
              </div>
              {% endfor %}
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="row">
      <div class="col-12 d-flex justify-content-between">
        <a href="{% url 'ventes' %}" class="btn btn-secondary">
          <i class="material-symbols-rounded me-1">arrow_back</i>
          Retour à la liste
        </a>
        <div>
          <a href="{% url 'generer_facture_pdf' vente.id %}" class="btn btn-success me-2" target="_blank">
            <i class="material-symbols-rounded me-1">description</i>
            Générer facture PDF
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Réutiliser le modal de paiement -->
<!-- Paiement Modal -->
<div class="modal fade" id="paiementModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ajouter un paiement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="card mb-3">
          <div class="card-header pb-0">
            <h6 class="text-dark font-weight-bolder">Facture courante - <span id="venteEcoleNom"></span> (<span id="venteAnnee"></span>)</h6>
          </div>
          <div class="card-body pt-2">
            <div class="row">
              <div class="col-md-4">
                <div class="info-item">
                  <p class="text-sm text-muted mb-1">Montant total de la facture</p>
                  <h6 class="font-weight-bolder text-dark mb-0"><span id="venteMontantTotal"></span> F</h6>
                </div>
              </div>
              <div class="col-md-4">
                <div class="info-item">
                  <p class="text-sm text-muted mb-1">Montant déjà payé</p>
                  <h6 class="font-weight-bolder text-success mb-0"><span id="venteMontantPaye"></span> F</h6>
                </div>
              </div>
              <div class="col-md-4">
                <div class="info-item">
                  <p class="text-sm text-muted mb-1">Montant restant</p>
                  <h6 class="font-weight-bolder text-warning mb-0"><span id="venteMontantRestant"></span> F</h6>
                </div>
              </div>
            </div>
          </div>
        </div>

        <form id="paiementModalForm" method="post">
          {% csrf_token %}
          <div class="row">
            <div class="col-12">
              <div class="input-group input-group-outline mb-3">
                <label class="form-label">Montant du paiement</label>
                <input class="form-control" name="montant" id="paiementMontant" type="number" step="0.01" required />
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" form="paiementModalForm" class="btn btn-primary">Enregistrer le paiement</button>
      </div>
    </div>
  </div>
</div>

<script>
  var paiementModal = document.getElementById('paiementModal')
  paiementModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget
    var venteId = button.getAttribute('data-vente-id')
    var montantTotal = parseFloat(button.getAttribute('data-montant-total')) || 0
    var montantPaye = parseFloat(button.getAttribute('data-montant-paye')) || 0
    var montantRestant = parseFloat(button.getAttribute('data-montant-restant')) || 0
    var ecoleNom = button.getAttribute('data-ecole-nom') || ''
    var annee = button.getAttribute('data-annee') || ''
    
    var form = document.getElementById('paiementModalForm')
    form.action = '/ventes/' + venteId + '/paiement/'
    
    document.getElementById('venteEcoleNom').textContent = ecoleNom
    document.getElementById('venteAnnee').textContent = annee
    document.getElementById('venteMontantTotal').textContent = montantTotal.toFixed(0)
    document.getElementById('venteMontantPaye').textContent = montantPaye.toFixed(0)
    document.getElementById('venteMontantRestant').textContent = montantRestant.toFixed(0)
    
    document.getElementById('paiementMontant').value = montantRestant.toFixed(0)
  })

  function supprimerLigne(ligneId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette ligne ?')) {
      // Ici il faudrait implémenter la suppression côté serveur
      console.log('Supprimer ligne:', ligneId)
    }
  }
</script>

{% endblock %}
