{% extends 'base.html' %}
{% block content %}
{% load static %}
<div class="container-fluid py-3">
  <!-- Header Section -->
  <div class="row align-items-center mb-4">
    <div class="col-md-8">
      <div class="d-flex align-items-center">
        <div class="icon-shape icon-lg bg-gradient-info shadow border-radius-xl me-3">
          <i class="material-symbols-rounded text-white" style="font-size: 2rem;">receipt_long</i>
        </div>
        <div>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 ps-0 me-sm-6 me-5">
              <li class="breadcrumb-item text-sm">
                <a class="text-dark" href="{% url 'ventes' %}">
                  <i class="material-symbols-rounded me-1">point_of_sale</i>
                  Ventes
                </a>
              </li>
              <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Détail</li>
            </ol>
          </nav>
          <h3 class="mb-0 font-weight-bolder text-dark">Détail de la vente</h3>
          <p class="mb-0 text-muted">{{ vente.ecole.nom }} • {{ vente.annee_scolaire }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4 text-end">
      <div class="d-flex justify-content-end gap-2">
        <a href="{% url 'ventes' %}" class="btn btn-outline-secondary">
          <i class="material-symbols-rounded me-1">arrow_back</i>
          Retour
        </a>
        <a href="{% url 'generer_facture_pdf' vente.id %}" class="btn bg-gradient-success shadow" target="_blank">
          <i class="material-symbols-rounded me-1">description</i>
          Facture PDF
        </a>
      </div>
    </div>
  </div>

  <!-- Messages Django -->
  {% if messages %}
    <div class="row mb-4">
      <div class="col-12">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show shadow" role="alert">
            <span class="alert-icon align-middle">
              <i class="material-symbols-rounded">
                {% if message.tags == 'success' %}check_circle
                {% elif message.tags == 'error' %}error
                {% elif message.tags == 'warning' %}warning
                {% else %}info{% endif %}
              </i>
            </span>
            <span class="alert-text text-white">{{ message }}</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <!-- Overview Cards -->
  <div class="row mb-4">
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card shadow-lg border-0">
        <div class="card-header p-3 pt-2">
          <div class="icon icon-lg icon-shape bg-gradient-primary shadow-primary text-center border-radius-xl mt-n4 position-absolute">
            <i class="material-symbols-rounded opacity-10">school</i>
          </div>
          <div class="text-end pt-1">
            <p class="text-sm mb-0 text-capitalize">École</p>
            <h4 class="mb-0 font-weight-bold">{{ vente.ecole.nom }}</h4>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-3">
          <p class="mb-0 text-sm">
            <span class="text-secondary">{{ vente.annee_scolaire }}</span>
          </p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card shadow-lg border-0">
        <div class="card-header p-3 pt-2">
          <div class="icon icon-lg icon-shape bg-gradient-success shadow-success text-center border-radius-xl mt-n4 position-absolute">
            <i class="material-symbols-rounded opacity-10">payments</i>
          </div>
          <div class="text-end pt-1">
            <p class="text-sm mb-0 text-capitalize">Montant Total</p>
            <h4 class="mb-0 font-weight-bold">{{ montant_total|floatformat:0 }} F</h4>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-3">
          <p class="mb-0 text-sm">
            <span class="text-success text-sm font-weight-bolder">{{ montant_paye|floatformat:0 }} F </span>
            payé
          </p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card shadow-lg border-0">
        <div class="card-header p-3 pt-2">
          <div class="icon icon-lg icon-shape {% if montant_restant <= 0 %}bg-gradient-success{% else %}bg-gradient-warning{% endif %} shadow-warning text-center border-radius-xl mt-n4 position-absolute">
            <i class="material-symbols-rounded opacity-10">account_balance_wallet</i>
          </div>
          <div class="text-end pt-1">
            <p class="text-sm mb-0 text-capitalize">Montant Restant</p>
            <h4 class="mb-0 font-weight-bold {% if montant_restant <= 0 %}text-success{% else %}text-warning{% endif %}">{{ montant_restant|floatformat:0 }} F</h4>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-3">
          <p class="mb-0 text-sm">
            {% if montant_restant <= 0 %}
              <span class="text-success text-sm font-weight-bolder">
                <i class="material-symbols-rounded text-sm">check_circle</i>
                Soldé
              </span>
            {% else %}
              <span class="text-warning text-sm font-weight-bolder">
                <i class="material-symbols-rounded text-sm">schedule</i>
                En attente
              </span>
            {% endif %}
          </p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6">
      <div class="card shadow-lg border-0">
        <div class="card-header p-3 pt-2">
          <div class="icon icon-lg icon-shape bg-gradient-info shadow-info text-center border-radius-xl mt-n4 position-absolute">
            <i class="material-symbols-rounded opacity-10">schedule</i>
          </div>
          <div class="text-end pt-1">
            <p class="text-sm mb-0 text-capitalize">Date Création</p>
            <h4 class="mb-0 font-weight-bold">{{ vente.created_at|date:"d/m" }}</h4>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-3">
          <p class="mb-0 text-sm">
            <span class="text-secondary">{{ vente.created_at|date:"Y à H:i" }}</span>
          </p>
        </div>
      </div>
    </div>
  </div>

    <!-- Articles vendus -->
  <!-- Articles par session d'ajout -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient-primary p-3">
          <div class="row align-items-center">
            <div class="col">
              <h6 class="mb-0 text-white font-weight-bolder">
                <i class="material-symbols-rounded me-2">schedule</i>
                Historique des ajouts d'articles
              </h6>
              <p class="text-white-50 text-sm mb-0">Articles groupés par moment d'ajout à la facture</p>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          {% if sessions %}
            {% for session in sessions %}
              <div class="session-group p-4 {% if not forloop.last %}border-bottom{% endif %}">
                <div class="row align-items-center mb-3">
                  <div class="col-md-8">
                    <div class="d-flex align-items-center">
                      <div class="icon-shape icon-sm bg-gradient-secondary shadow border-radius-md me-3">
                        <i class="material-symbols-rounded text-white text-sm">shopping_cart</i>
                      </div>
                      <div>
                        <h6 class="mb-0 text-dark font-weight-bold">Session #{{ forloop.counter }}</h6>
                        <small class="text-muted">
                          <i class="material-symbols-rounded me-1" style="font-size: 14px;">schedule</i>
                          {{ session.date_session|date:"d/m/Y à H:i" }}
                        </small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4 text-end">
                    <div class="d-flex flex-column align-items-end">
                      <span class="badge badge-lg bg-gradient-success mb-1">{{ session.montant_total|floatformat:0 }} F</span>
                      <small class="text-muted">{{ session.nombre_articles }} article{{ session.nombre_articles|pluralize }}</small>
                    </div>
                  </div>
                </div>
                
                <div class="table-responsive">
                  <table class="table align-items-center mb-0">
                    <thead class="bg-gray-100">
                      <tr>
                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Cahier</th>
                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Quantité</th>
                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-end">Prix unitaire</th>
                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-end">Montant</th>
                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Heure</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for ligne in session.lignes %}
                      <tr>
                        <td>
                          <div class="d-flex align-items-center">
                            <div class="icon-shape icon-xs bg-gradient-info shadow border-radius-sm me-2">
                              <i class="material-symbols-rounded text-white text-xs">book</i>
                            </div>
                            <span class="text-sm font-weight-bold">{{ ligne.cahier.titre }}</span>
                          </div>
                        </td>
                        <td class="text-center">
                          <span class="badge badge-sm bg-gradient-secondary">{{ ligne.quantite }}</span>
                        </td>
                        <td class="text-end">
                          <span class="text-sm font-weight-bold">{{ ligne.cahier.prix|floatformat:0 }} F</span>
                        </td>
                        <td class="text-end">
                          <span class="text-sm font-weight-bold text-success">{{ ligne.montant|floatformat:0 }} F</span>
                        </td>
                        <td class="text-center">
                          <small class="text-muted">{{ ligne.date_ajout|date:"H:i:s" }}</small>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-center p-5">
              <div class="icon-shape icon-xxl bg-gradient-light shadow border-radius-xl mx-auto mb-3">
                <i class="material-symbols-rounded text-muted" style="font-size: 3rem;">inventory_2</i>
              </div>
              <h5 class="text-muted mb-2">Aucun article</h5>
              <p class="text-sm text-muted">Cette vente ne contient aucun article pour le moment.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Articles par type (vue classique) -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient-info p-3">
          <div class="row align-items-center">
            <div class="col">
              <h6 class="mb-0 text-white font-weight-bolder">
                <i class="material-symbols-rounded me-2">list_alt</i>
                Articles par type
              </h6>
              <p class="text-white-50 text-sm mb-0">Vue groupée par type de cahier</p>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          {% if ligne_ventes %}
            <div class="table-responsive">
              <table class="table align-items-center mb-0">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-4">Type de cahier</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Quantité totale</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-end">Prix unitaire</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-end pe-4">Montant total</th>
                  </tr>
                </thead>
                <tbody>
                  {% for ligne in ligne_ventes %}
                  <tr>
                    <td class="ps-4">
                      <div class="d-flex align-items-center">
                        <div class="icon-shape icon-sm bg-gradient-success shadow border-radius-md me-3">
                          <i class="material-symbols-rounded text-white text-sm">book</i>
                        </div>
                        <span class="text-sm font-weight-bold">{{ ligne.cahier.titre }}</span>
                      </div>
                    </td>
                    <td class="text-center">
                      <span class="badge badge-lg bg-gradient-primary">{{ ligne.quantite_totale }}</span>
                    </td>
                    <td class="text-end">
                      <span class="text-sm font-weight-bold">{{ ligne.cahier.prix|floatformat:0 }} F</span>
                    </td>
                    <td class="text-end pe-4">
                      <span class="text-lg font-weight-bold text-success">{{ ligne.montant_total|floatformat:0 }} F</span>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center p-5">
              <div class="icon-shape icon-xxl bg-gradient-light shadow border-radius-xl mx-auto mb-3">
                <i class="material-symbols-rounded text-muted" style="font-size: 3rem;">inventory_2</i>
              </div>
              <h5 class="text-muted mb-2">Aucun article</h5>
              <p class="text-sm text-muted">Cette vente ne contient aucun article pour le moment.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>  <!-- Paiements -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient-success p-3">
          <div class="row align-items-center">
            <div class="col">
              <h6 class="mb-0 text-white font-weight-bolder">
                <i class="material-symbols-rounded me-2">payments</i>
                Historique des paiements
              </h6>
            </div>
            <div class="col-auto">
              <button class="btn btn-white btn-sm shadow" data-bs-toggle="modal" data-bs-target="#paiementModal" 
                      data-vente-id="{{ vente.id }}" 
                      data-montant-total="{{ montant_total }}"
                      data-montant-paye="{{ montant_paye }}"
                      data-montant-restant="{{ montant_restant }}"
                      data-ecole-nom="{{ vente.ecole.nom }}"
                      data-annee="{{ vente.annee_scolaire }}"
                      data-dettes-autres="[]"
                      data-total-dettes-autres="0">
                <i class="material-symbols-rounded me-1">add</i>
                Ajouter un paiement
              </button>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          {% if paiements %}
            <div class="table-responsive">
              <table class="table align-items-center mb-0">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-4">Date</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Tranche</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-end pe-4">Montant</th>
                  </tr>
                </thead>
                <tbody>
                  {% for paiement in paiements %}
                  <tr>
                    <td class="ps-4">
                      <div class="d-flex align-items-center">
                        <div class="icon-shape icon-sm bg-gradient-primary shadow border-radius-md me-3">
                          <i class="material-symbols-rounded text-white text-sm">calendar_today</i>
                        </div>
                        <span class="text-sm font-weight-bold">{{ paiement.date_paiement|date:"d/m/Y" }}</span>
                      </div>
                    </td>
                    <td>
                      <span class="badge badge-sm bg-gradient-info">Tranche {{ paiement.numero_tranche }}</span>
                    </td>
                    <td class="text-end pe-4">
                      <span class="text-lg font-weight-bold text-success">{{ paiement.montant|floatformat:0 }} F</span>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center p-5">
              <div class="icon-shape icon-xxl bg-gradient-light shadow border-radius-xl mx-auto mb-3">
                <i class="material-symbols-rounded text-muted" style="font-size: 3rem;">payments</i>
              </div>
              <h5 class="text-muted mb-2">Aucun paiement</h5>
              <p class="text-sm text-muted mb-4">Aucun paiement n'a encore été enregistré pour cette vente.</p>
              <button class="btn bg-gradient-success" data-bs-toggle="modal" data-bs-target="#paiementModal" 
                      data-vente-id="{{ vente.id }}" 
                      data-montant-total="{{ montant_total }}"
                      data-montant-paye="{{ montant_paye }}"
                      data-montant-restant="{{ montant_restant }}"
                      data-ecole-nom="{{ vente.ecole.nom }}"
                      data-annee="{{ vente.annee_scolaire }}"
                      data-dettes-autres="[]"
                      data-total-dettes-autres="0">
                <i class="material-symbols-rounded me-1">add</i>
                Premier paiement
              </button>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Autres ventes de la même école -->
  {% if related_groups %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient-secondary p-3">
          <div class="row align-items-center">
            <div class="col">
              <h6 class="mb-0 text-white font-weight-bolder">
                <i class="material-symbols-rounded me-2">history</i>
                Autres ventes ({{ vente.ecole.nom }})
              </h6>
            </div>
          </div>
        </div>
        <div class="card-body p-4">
          {% for date, ventes_groupe in related_groups.items %}
          <div class="mb-4 {% if not forloop.last %}border-bottom pb-3{% endif %}">
            <h6 class="text-sm text-muted font-weight-bold mb-3">
              <i class="material-symbols-rounded me-1" style="font-size: 16px;">calendar_today</i>
              {{ date }}
            </h6>
            <div class="row">
              {% for v in ventes_groupe %}
              <div class="col-md-6 col-lg-4 mb-3">
                <div class="card border shadow-sm">
                  <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                      <div class="d-flex align-items-center">
                        <div class="icon-shape icon-sm bg-gradient-info shadow border-radius-md me-2">
                          <i class="material-symbols-rounded text-white text-xs">receipt</i>
                        </div>
                        <div>
                          <h6 class="mb-0 text-sm font-weight-bold">{{ v.id|slice:":8" }}...</h6>
                          <small class="text-muted">{{ v.annee_scolaire }}</small>
                        </div>
                      </div>
                      <a href="{% url 'vente_detail' v.id %}" class="btn btn-outline-primary btn-sm">
                        <i class="material-symbols-rounded text-xs">visibility</i>
                        Voir
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Modal de paiement modernisé -->
<div class="modal fade" id="paiementModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-gradient-success">
        <h5 class="modal-title text-white font-weight-bolder">
          <i class="material-symbols-rounded me-2">payments</i>
          Ajouter un paiement
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="card border-0 shadow">
          <div class="card-header bg-gradient-light">
            <h6 class="text-dark font-weight-bolder mb-0">
              <i class="material-symbols-rounded me-2">receipt_long</i>
              Facture courante - <span id="venteEcoleNom"></span> (<span id="venteAnnee"></span>)
            </h6>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-4">
                <div class="info-item p-3">
                  <div class="icon-shape icon-sm bg-gradient-primary shadow border-radius-md mx-auto mb-2">
                    <i class="material-symbols-rounded text-white text-sm">account_balance_wallet</i>
                  </div>
                  <p class="text-sm text-muted mb-1">Montant total</p>
                  <h5 class="font-weight-bolder text-dark mb-0"><span id="venteMontantTotal"></span> F</h5>
                </div>
              </div>
              <div class="col-md-4">
                <div class="info-item p-3">
                  <div class="icon-shape icon-sm bg-gradient-success shadow border-radius-md mx-auto mb-2">
                    <i class="material-symbols-rounded text-white text-sm">check_circle</i>
                  </div>
                  <p class="text-sm text-muted mb-1">Montant payé</p>
                  <h5 class="font-weight-bolder text-success mb-0"><span id="venteMontantPaye"></span> F</h5>
                </div>
              </div>
              <div class="col-md-4">
                <div class="info-item p-3">
                  <div class="icon-shape icon-sm bg-gradient-warning shadow border-radius-md mx-auto mb-2">
                    <i class="material-symbols-rounded text-white text-sm">schedule</i>
                  </div>
                  <p class="text-sm text-muted mb-1">Montant restant</p>
                  <h5 class="font-weight-bolder text-warning mb-0"><span id="venteMontantRestant"></span> F</h5>
                </div>
              </div>
            </div>
          </div>
        </div>

        <form id="paiementModalForm" method="post" class="mt-4">
          {% csrf_token %}
          <div class="input-group input-group-outline mb-3">
            <label class="form-label">Montant du paiement (F)</label>
            <input class="form-control" name="montant" id="paiementMontant" type="number" step="0.01" required />
          </div>
          
          <div class="alert alert-info border-0 shadow-sm" role="alert">
            <div class="d-flex align-items-center">
              <div class="icon-shape icon-sm bg-gradient-info shadow border-radius-md me-3">
                <i class="material-symbols-rounded text-white text-sm">info</i>
              </div>
              <span class="text-sm">
                <strong>Astuce :</strong> Le montant recommandé correspond au solde restant de cette vente.
              </span>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="material-symbols-rounded me-1">close</i>
          Annuler
        </button>
        <button type="submit" form="paiementModalForm" class="btn bg-gradient-success shadow">
          <i class="material-symbols-rounded me-1">save</i>
          Enregistrer le paiement
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  var paiementModal = document.getElementById('paiementModal')
  paiementModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget
    var venteId = button.getAttribute('data-vente-id')
    var montantTotal = parseFloat(button.getAttribute('data-montant-total')) || 0
    var montantPaye = parseFloat(button.getAttribute('data-montant-paye')) || 0
    var montantRestant = parseFloat(button.getAttribute('data-montant-restant')) || 0
    var ecoleNom = button.getAttribute('data-ecole-nom') || ''
    var annee = button.getAttribute('data-annee') || ''
    
    var form = document.getElementById('paiementModalForm')
    form.action = '/ventes/' + venteId + '/paiement/'
    
    document.getElementById('venteEcoleNom').textContent = ecoleNom
    document.getElementById('venteAnnee').textContent = annee
    document.getElementById('venteMontantTotal').textContent = montantTotal.toFixed(0)
    document.getElementById('venteMontantPaye').textContent = montantPaye.toFixed(0)
    document.getElementById('venteMontantRestant').textContent = montantRestant.toFixed(0)
    
    document.getElementById('paiementMontant').value = montantRestant.toFixed(0)
  })

  function supprimerLigne(ligneId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette ligne ?')) {
      // Ici il faudrait implémenter la suppression côté serveur
      console.log('Supprimer ligne:', ligneId)
    }
  }
</script>

{% endblock %}
