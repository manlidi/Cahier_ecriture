{% extends 'base.html' %}
{% block content %}
{% load static %}
<div class="container-fluid py-3">
  <!-- Header Section -->
  <div class="row align-items-center mb-4">
    <div class="col-md-8">
      <div class="d-flex align-items-center">
        <div class="icon-shape icon-lg bg-gradient-secondary shadow border-radius-xl me-3">
          <i class="material-symbols-rounded text-white" style="font-size: 2rem;">point_of_sale</i>
        </div>
        <div>
          <h3 class="mb-0 font-weight-bolder text-dark">Gestion des Ventes</h3>
          <p class="mb-0 text-muted">Suivi et administration de toutes les transactions</p>
        </div>
      </div>
    </div>
    <div class="col-md-4 text-end">
      <button type="button" class="btn bg-gradient-secondary btn-lg shadow-primary" data-bs-toggle="modal" data-bs-target="#modalNouvelleVente">
        <i class="material-symbols-rounded me-2">add_circle</i>
        Nouvelle Vente
      </button>
    </div>
  </div>

  <!-- Filters Card -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient-light p-3">
          <div class="row align-items-center">
            <div class="col">
              <h6 class="mb-0 text-dark font-weight-bolder">
                <i class="material-symbols-rounded me-2">filter_list</i>
                Filtres de recherche
              </h6>
            </div>
          </div>
        </div>
        <div class="card-body p-4">
          <style>
            .search-select-container {
              position: relative;
              width: 100%;
            }
            
            .dropdown-list {
              position: absolute;
              top: 100%;
              left: 0;
              right: 0;
              background: white;
              border: 1px solid #ced4da;
              border-top: none;
              border-radius: 0 0 4px 4px;
              max-height: 200px;
              overflow-y: auto;
              z-index: 1000;
              display: none;
            }
            
            .dropdown-item {
              padding: 8px 12px;
              cursor: pointer;
              border-bottom: 1px solid #f1f1f1;
            }
            
            .dropdown-item:hover {
              background-color: #f8f9fa;
            }
            
            .dropdown-item.selected {
              background-color: #007bff;
              color: white;
            }
            
            .dropdown-item:last-child {
              border-bottom: none;
            }
            
            #ecoleSearchInput:focus + .dropdown-list,
            .dropdown-list.show {
              display: block;
            }
          </style>
          <form method="get" class="row g-3">
            <div class="col-lg-8 col-md-8">
              <div class="input-group input-group-outline position-relative">
                <div class="search-select-container">
                  <input type="text" id="ecoleSearchInput" class="form-control border border-secondary" placeholder="Rechercher une école..." autocomplete="off">
                  <select name="ecole" id="ecole" style="display: none;">
                    <option value="">-- Toutes les écoles --</option>
                    {% for e in ecoles %}
                      <option value="{{ e.id }}" {% if selected_ecole == e.id|stringformat:'s' %}selected{% endif %}>{{ e.nom }}</option>
                    {% endfor %}
                  </select>
                  <div id="ecoleDropdownList" class="dropdown-list">
                    <!-- Options dynamiques ici -->
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4 col-md-4 d-flex align-items-end">
              <button type="submit" class="btn bg-gradient-info w-100 shadow">
                <i class="material-symbols-rounded me-2">search</i>
                Appliquer le filtre
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Sales List Card -->
  <div class="row">
    <div class="col-12">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient-secondary p-3">
          <div class="row align-items-center">
            <div class="col">
              <h6 class="mb-0 text-white font-weight-bolder">
                <i class="material-symbols-rounded me-2">receipt_long</i>
                Liste des ventes
                {% if ventes %}
                  <span class="badge bg-light text-dark ms-2">{{ ventes.paginator.count }} vente{{ ventes.paginator.count|pluralize }}</span>
                {% endif %}
              </h6>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          {% if ventes %}
            <div class="table-responsive">
              <table class="table align-items-center mb-0">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-4">Vente</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">École</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Montants</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Statut</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Articles</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for v in ventes %}
                    <tr class="border-bottom">
                      <td class="ps-4">
                        <div class="d-flex align-items-center">
                          <div class="icon-shape icon-sm bg-gradient-secondary shadow border-radius-md me-3">
                            <i class="material-symbols-rounded text-white">receipt</i>
                          </div>
                          <div>
                            <h6 class="mb-0 text-sm font-weight-bold">{{ v.short_id }}</h6>
                            <p class="text-xs text-muted mb-0">{{ v.created_at.date|date:"d/m/Y" }}</p>
                            <small class="text-xs text-info">{{ v.annee_scolaire }}</small>
                          </div>
                        </div>
                      </td>
                      <td>
                        <div>
                          <h6 class="mb-0 text-sm font-weight-bold">{{ v.ecole.nom }}</h6>
                          <p class="text-xs text-muted mb-0">{{ v.created_at|date:"H:i" }}</p>
                        </div>
                      </td>
                      <td>
                        <div class="d-flex flex-column">
                          <span class="text-sm font-weight-bold text-dark">Total: {{ v.montant_total|floatformat:0 }} F</span>
                          <span class="text-xs text-success">Payé: {{ v.montant_paye|floatformat:0 }} F</span>
                          <span class="text-xs {% if v.montant_restant > 0 %}text-warning{% else %}text-muted{% endif %}">
                            Restant: {{ v.montant_restant|floatformat:0 }} F
                          </span>
                          {% if v.dette_totale_ecole > 0 %}
                            <span class="text-xs text-danger mt-1" title="Dette totale de l'école toutes années confondues">
                              <i class="material-symbols-rounded text-xs me-1">priority_high</i>
                              Dette totale école: {{ v.dette_totale_ecole|floatformat:0 }} F
                            </span>
                          {% endif %}
                        </div>
                      </td>
                      <td>
                        {% if v.montant_restant > 0 and v.montant_paye == 0 %}
                          <span class="badge badge-sm bg-gradient-danger">
                            <i class="material-symbols-rounded text-xs me-1">error</i>
                            Impayé
                          </span>
                        {% elif v.montant_restant > 0 and v.montant_paye > 0 %}
                          <span class="badge badge-sm bg-gradient-warning">
                            <i class="material-symbols-rounded text-xs me-1">schedule</i>
                            Partiel
                          </span>
                        {% elif v.montant_restant <= 0 %}
                          <span class="badge badge-sm bg-gradient-success">
                            <i class="material-symbols-rounded text-xs me-1">check_circle</i>
                            Payé
                          </span>
                        {% endif %}
                      </td>
                      <td>
                        <div class="d-flex align-items-center">
                          <div class="icon-shape icon-xs bg-gradient-info shadow border-radius-sm me-2">
                            <i class="material-symbols-rounded text-white text-xs">inventory</i>
                          </div>
                          <span class="text-sm font-weight-bold">{{ v.lignes_count }}</span>
                        </div>
                      </td>
                      <td class="text-center">
                        <div class="d-flex justify-content-center gap-1">
                          <!-- Bouton Détails -->
                          <a class="btn btn-link text-info p-2 mb-0" href="{% url 'vente_detail' v.id %}" 
                             title="Voir les détails" data-bs-toggle="tooltip">
                            <i class="material-symbols-rounded text-sm">visibility</i>
                          </a>
                          
                          <!-- Bouton Facture PDF -->
                          <a class="btn btn-link text-secondary p-2 mb-0" href="{% url 'generer_facture_pdf' v.id %}" 
                             title="Générer la facture PDF" data-bs-toggle="tooltip" target="_blank">
                            <i class="material-symbols-rounded text-sm">description</i>
                          </a>
                          
                          <!-- Bouton Paiement -->
                          {% if v.montant_restant > 0 or v.total_dettes_autres > 0 %}
                          <button class="btn btn-link text-success p-2 mb-0" data-bs-toggle="modal" data-bs-target="#paiementModal" 
                                  title="{% if v.montant_restant > 0 %}Ajouter un paiement{% else %}Payer les dettes antérieures{% endif %}" data-bs-toggle="tooltip"
                                  data-vente-id="{{ v.id }}" 
                                  data-montant-total="{{ v.montant_total }}"
                                  data-montant-paye="{{ v.montant_paye }}"
                                  data-montant-restant="{{ v.montant_restant }}"
                                  data-ecole-nom="{{ v.ecole.nom }}"
                                  data-annee="{{ v.annee_scolaire }}"
                                  data-dettes-autres='{{ v.dettes_autres_json }}'
                                  data-total-dettes-autres="{{ v.total_dettes_autres }}"
                                  data-dette-totale-ecole="{{ v.dette_totale_ecole }}">
                            <i class="material-symbols-rounded text-sm">payments</i>
                          </button>
                          {% endif %}
                          
                          <!-- Bouton Ajouter article -->
                          {% if v.annee_scolaire.est_active %}
                          <button class="btn btn-link text-warning p-2 mb-0" data-bs-toggle="modal" data-bs-target="#modifierModal" 
                                  title="Ajouter un article" data-bs-toggle="tooltip"
                                  data-vente-id="{{ v.id }}">
                            <i class="material-symbols-rounded text-sm">add_shopping_cart</i>
                          </button>
                          {% endif %}

                          <button class="btn btn-link text-danger p-2 mb-0" data-bs-toggle="modal" data-bs-target="#retirerModal"
                                  title="Retirer des cahiers" data-bs-toggle="tooltip"
                                  data-vente-id="{{ v.id }}">
                            <i class="material-symbols-rounded text-sm">remove_shopping_cart</i>
                          </button>

                          <!-- Bouton Supprimer la vente -->
                          <button class="btn btn-link text-danger p-2 mb-0" data-bs-toggle="modal" data-bs-target="#supprimerVenteModal"
                                  title="Supprimer la vente" data-bs-toggle="tooltip"
                                  data-vente-id="{{ v.id }}"
                                  data-vente-ecole="{{ v.ecole.nom }}"
                                  data-vente-montant="{{ v.montant_total|floatformat:0 }}"
                                  data-vente-date="{{ v.created_at.date|date:'d/m/Y' }}">
                            <i class="material-symbols-rounded text-sm">delete_forever</i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center p-5">
              <div class="icon-shape icon-xxl bg-gradient-light shadow border-radius-xl mx-auto mb-3">
                <i class="material-symbols-rounded text-muted" style="font-size: 3rem;">receipt_long</i>
              </div>
              <h5 class="text-muted mb-2">Aucune vente trouvée</h5>
              <p class="text-sm text-muted mb-4">Il n'y a pas de ventes correspondant à vos critères de recherche.</p>
              <button type="button" class="btn bg-gradient-primary" data-bs-toggle="modal" data-bs-target="#modalNouvelleVente">
                <i class="material-symbols-rounded me-2">add_circle</i>
                Créer la première vente
              </button>
            </div>
          {% endif %}
          
          <!-- Pagination -->
          {% if ventes.has_other_pages %}
          <div class="d-flex justify-content-center p-4 border-top">
            <nav aria-label="Navigation des pages">
              <ul class="pagination pagination-primary">
                {% if ventes.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?{% if selected_ecole %}ecole={{ selected_ecole }}&{% endif %}page={{ ventes.previous_page_number }}">
                      <i class="material-symbols-rounded">chevron_left</i>
                    </a>
                  </li>
                {% endif %}
                
                {% for page_num in ventes.paginator.page_range %}
                  {% if page_num == ventes.number %}
                    <li class="page-item active">
                      <span class="page-link">{{ page_num }}</span>
                    </li>
                  {% elif page_num == 1 or page_num == ventes.paginator.num_pages or page_num >= ventes.number|add:'-2' and page_num <= ventes.number|add:'2' %}
                    <li class="page-item">
                      <a class="page-link" href="?{% if selected_ecole %}ecole={{ selected_ecole }}&{% endif %}page={{ page_num }}">{{ page_num }}</a>
                    </li>
                  {% elif page_num == 2 and ventes.number > 4 %}
                    <li class="page-item disabled">
                      <span class="page-link">...</span>
                    </li>
                  {% elif page_num == ventes.paginator.num_pages|add:'-1' and ventes.number < ventes.paginator.num_pages|add:'-3' %}
                    <li class="page-item disabled">
                      <span class="page-link">...</span>
                    </li>
                  {% endif %}
                {% endfor %}
                
                {% if ventes.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?{% if selected_ecole %}ecole={{ selected_ecole }}&{% endif %}page={{ ventes.next_page_number }}">
                      <i class="material-symbols-rounded">chevron_right</i>
                    </a>
                  </li>
                {% endif %}
              </ul>
            </nav>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Retirer Modal -->
<div class="modal fade" id="retirerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Retirer des cahiers de la vente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="retirerModalForm" method="post">
        {% csrf_token %}
        <div class="modal-body">
          <div id="retirer-articles-container"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-danger">Retirer</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de paiement modernisé -->
<div class="modal fade" id="paiementModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-gradient-secondary">
        <h5 class="modal-title text-white font-weight-bolder">
          <i class="material-symbols-rounded me-2">payments</i>
          Ajouter un paiement
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="card border-0 shadow">
          <div class="card-header bg-gradient-light">
            <h6 class="text-dark font-weight-bolder mb-0">
              <i class="material-symbols-rounded me-2">receipt_long</i>
              Facture courante - <span id="venteEcoleNom"></span> (<span id="venteAnnee"></span>)
            </h6>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-4">
                <div class="info-item p-3">
                  <div class="icon-shape icon-sm bg-gradient-primary shadow border-radius-md mx-auto mb-2">
                    <i class="material-symbols-rounded text-white text-sm">account_balance_wallet</i>
                  </div>
                  <p class="text-sm text-muted mb-1">Montant total</p>
                  <h5 class="font-weight-bolder text-dark mb-0"><span id="venteMontantTotal"></span> F</h5>
                </div>
              </div>
              <div class="col-md-4">
                <div class="info-item p-3">
                  <div class="icon-shape icon-sm bg-gradient-success shadow border-radius-md mx-auto mb-2">
                    <i class="material-symbols-rounded text-white text-sm">check_circle</i>
                  </div>
                  <p class="text-sm text-muted mb-1">Montant payé</p>
                  <h5 class="font-weight-bolder text-success mb-0"><span id="venteMontantPaye"></span> F</h5>
                </div>
              </div>
              <div class="col-md-4">
                <div class="info-item p-3">
                  <div class="icon-shape icon-sm bg-gradient-warning shadow border-radius-md mx-auto mb-2">
                    <i class="material-symbols-rounded text-white text-sm">schedule</i>
                  </div>
                  <p class="text-sm text-muted mb-1">Montant restant</p>
                  <h5 class="font-weight-bolder text-warning mb-0"><span id="venteMontantRestant"></span> F</h5>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Section Dette École (si elle existe) -->
        <div id="dettesEcoleSection" class="card border-0 shadow mt-3" style="display: none;">
          <div class="alert alert-light border-0" role="alert">
            <div class="d-flex align-items-center">
              <div>
                <p class="mb-1 text-sm font-weight-bold">Dette totale de l'école : <span id="modalTotalDettesEcole"></span> F</p>
                <p class="mb-0 text-xs">Cette dette inclut toutes les ventes impayées de cette école pour toutes les années scolaires.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Dettes des autres années (détaillées) -->
        <div class="card border-0 shadow mt-3" id="dettesAutresCard" style="display:none;">
          <div class="card-header bg-gradient-light">
            <h6 class="text-dark font-weight-bolder mb-0">
              <i class="material-symbols-rounded me-2">history</i>
              Dettes précédentes
            </h6>
          </div>
          <div class="card-body">
            <div id="dettesAutresList"></div>
            <hr class="horizontal dark">
            <div class="row">
              <div class="col-12">
                <div class="info-item text-center">
                  <p class="text-sm text-muted mb-1">Total des dettes précédentes</p>
                  <h5 class="font-weight-bolder text-danger mb-0"><span id="totalDettesAutres"></span> F</h5>
                </div>
              </div>
            </div>
          </div>
        </div>

        <form id="paiementModalForm" method="post" class="mt-4">
          {% csrf_token %}
          <div class="input-group input-group-outline mb-3">
            <input class="form-control" name="montant" id="paiementMontant" type="number" step="0.01" required placeholder="Montant du paiement (F)" placeholder="Montant du paiement (F)" />
          </div>
          
        </form>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="material-symbols-rounded me-1">close</i>
          Annuler
        </button>
        <button type="submit" form="paiementModalForm" class="btn bg-gradient-success shadow">
          <i class="material-symbols-rounded me-1">save</i>
          Enregistrer le paiement
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modifier Modal -->
<div class="modal fade" id="modifierModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ajouter des articles à la vente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="modifierModalForm" method="post">
        {% csrf_token %}
        <div class="modal-body">
          <div id="articles-container">
            <!-- template ligne article -->
          </div>
          <div class="d-flex justify-content-between align-items-center mt-3">
            <button id="add-article-btn" type="button" class="btn btn-outline-primary">
              <i class="material-symbols-rounded">add</i> Ajouter un article
            </button>
            <div class="card">
              <div class="card-body p-2">
                <p class="text-sm mb-0">Prix total sélection</p>
                <h5 class="font-weight-bolder mb-0"><span id="total-selected">0</span> F</h5>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Ajouter à la vente</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
  // Fonction générique pour transformer un select en champ de recherche
  function createSearchableSelect(options) {
    var searchInput = options.searchInput;
    var hiddenSelect = options.hiddenSelect;
    var dropdownList = options.dropdownList;
    var placeholder = options.placeholder || 'Rechercher...';
    var onSelectionChange = options.onSelectionChange || function() {};
    
    if (!searchInput || !hiddenSelect || !dropdownList) {
      console.error('Éléments manquants pour le select avec recherche:', options);
      return null;
    }
    
    var allOptions = [];
    var selectedIndex = -1;
    
    // Extraire toutes les options du select
    for (var i = 0; i < hiddenSelect.options.length; i++) {
      var option = hiddenSelect.options[i];
      allOptions.push({
        value: option.value,
        text: option.text,
        selected: option.selected
      });
      
      // Pré-remplir l'input si une option est sélectionnée
      if (option.selected && option.value !== '') {
        searchInput.value = option.text;
      }
    }
    
    // Fonction pour créer et afficher la liste
    function showDropdown(filteredOptions) {
      dropdownList.innerHTML = '';
      filteredOptions.forEach(function(option, index) {
        var item = document.createElement('div');
        item.className = 'dropdown-item';
        item.textContent = option.text;
        item.setAttribute('data-value', option.value);
        item.setAttribute('data-index', index);
        
        item.addEventListener('click', function() {
          searchInput.value = option.text;
          hiddenSelect.value = option.value;
          dropdownList.style.display = 'none';
          selectedIndex = -1;
          onSelectionChange(option);
        });
        
        dropdownList.appendChild(item);
      });
      
      dropdownList.style.display = filteredOptions.length > 0 ? 'block' : 'none';
      selectedIndex = -1;
    }
    
    // Fonction pour filtrer les options
    function filterOptions(searchTerm) {
      var filtered = allOptions.filter(function(option) {
        return option.text.toLowerCase().includes(searchTerm.toLowerCase());
      });
      showDropdown(filtered);
    }
    
    // Événements sur l'input de recherche
    searchInput.addEventListener('input', function() {
      var searchTerm = this.value;
      if (searchTerm === '') {
        hiddenSelect.value = '';
        showDropdown(allOptions);
      } else {
        filterOptions(searchTerm);
      }
    });
    
    searchInput.addEventListener('focus', function() {
      if (this.value === '') {
        showDropdown(allOptions);
      } else {
        filterOptions(this.value);
      }
    });
    
    // Navigation au clavier
    searchInput.addEventListener('keydown', function(e) {
      var items = dropdownList.querySelectorAll('.dropdown-item');
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
        updateSelection(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateSelection(items);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (selectedIndex >= 0 && items[selectedIndex]) {
          items[selectedIndex].click();
        }
      } else if (e.key === 'Escape') {
        dropdownList.style.display = 'none';
        selectedIndex = -1;
      }
    });
    
    function updateSelection(items) {
      items.forEach(function(item, index) {
        if (index === selectedIndex) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
    }
    
    // Fermer la liste quand on clique ailleurs
    document.addEventListener('click', function(e) {
      if (!searchInput.contains(e.target) && !dropdownList.contains(e.target)) {
        dropdownList.style.display = 'none';
        selectedIndex = -1;
      }
    });
    
    // Effacer la sélection si l'input est vidé
    searchInput.addEventListener('blur', function() {
      setTimeout(function() {
        var inputValue = searchInput.value;
        var found = allOptions.find(function(opt) {
          return opt.text === inputValue;
        });
        
        if (!found) {
          hiddenSelect.value = '';
        }
      }, 200);
    });
    
    return {
      refresh: function() {
        // Recharger les options du select
        allOptions = [];
        for (var i = 0; i < hiddenSelect.options.length; i++) {
          var option = hiddenSelect.options[i];
          allOptions.push({
            value: option.value,
            text: option.text,
            selected: option.selected
          });
        }
      },
      setValue: function(value) {
        var option = allOptions.find(function(opt) {
          return opt.value === value;
        });
        if (option) {
          searchInput.value = option.text;
          hiddenSelect.value = option.value;
        }
      },
      clear: function() {
        searchInput.value = '';
        hiddenSelect.value = '';
        dropdownList.style.display = 'none';
      }
    };
  }

  // Using Bootstrap 5 modal events
  var paiementModal = document.getElementById('paiementModal')
  paiementModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget
    var venteId = button.getAttribute('data-vente-id')
    var montantTotal = parseFloat(button.getAttribute('data-montant-total')) || 0
    var montantPaye = parseFloat(button.getAttribute('data-montant-paye')) || 0
    var montantRestant = parseFloat(button.getAttribute('data-montant-restant')) || 0
    var ecoleNom = button.getAttribute('data-ecole-nom') || ''
    var annee = button.getAttribute('data-annee') || ''
    var dettesAutresData = button.getAttribute('data-dettes-autres') || '[]'
    var totalDettesAutres = parseFloat(button.getAttribute('data-total-dettes-autres')) || 0
    var detteTotaleEcole = parseFloat(button.getAttribute('data-dette-totale-ecole')) || 0
    
    console.log('Raw dettesAutresData:', dettesAutresData)
    console.log('Type of dettesAutresData:', typeof dettesAutresData)
    console.log('Modal data:', {montantTotal, montantPaye, montantRestant, dettesAutresData, totalDettesAutres})
    console.log('Parsed dettes:', dettesAutres)
    
    var form = document.getElementById('paiementModalForm')
    form.action = '/ventes/' + venteId + '/paiement/'
    
    // Remplir les informations de base de la facture courante
    document.getElementById('venteEcoleNom').textContent = ecoleNom
    document.getElementById('venteAnnee').textContent = annee
    document.getElementById('venteMontantTotal').textContent = montantTotal.toLocaleString()
    document.getElementById('venteMontantPaye').textContent = montantPaye.toLocaleString()
    document.getElementById('venteMontantRestant').textContent = montantRestant.toLocaleString()
    
    // Calculer le montant recommandé initial (facture courante)
    var montantRecommande = montantRestant
    
    // Afficher la dette totale de l'école si elle existe
    var dettesEcoleSection = document.getElementById('dettesEcoleSection')
    if (detteTotaleEcole > 0) {
      document.getElementById('modalTotalDettesEcole').textContent = detteTotaleEcole.toLocaleString()
      dettesEcoleSection.style.display = 'block'
      // Le montant recommandé devient la dette totale de l'école
      montantRecommande = detteTotaleEcole
      console.log('Dette totale de l\'école affichée:', detteTotaleEcole)
    } else {
      dettesEcoleSection.style.display = 'none'
      console.log('Aucune dette totale d\'école - section cachée')
    }

    // Parse et afficher les dettes détaillées par année (optionnel)
    var dettesAutres = []
    try {
      dettesAutres = JSON.parse(dettesAutresData)
    } catch(e) {
      console.error('Error parsing dettes:', e)
    }
    
    var dettesCard = document.getElementById('dettesAutresCard')
    var dettesList = document.getElementById('dettesAutresList')
    
    if (dettesAutres.length > 0) {
      dettesCard.style.display = 'block'
      dettesList.innerHTML = ''
      
      dettesAutres.forEach(function(dette, index) {
        var div = document.createElement('div')
        div.className = 'row mb-2'
        div.innerHTML = `
          <div class="col-8">
            <p class="text-sm mb-0">${dette.annee_scolaire}</p>
            <small class="text-muted">Vente du ${dette.date_creation || 'N/A'}</small>
          </div>
          <div class="col-4 text-end">
            <span class="text-danger font-weight-bolder">${parseFloat(dette.montant_restant).toLocaleString()} F</span>
          </div>
        `
        dettesList.appendChild(div)
      })
      
      document.getElementById('totalDettesAutres').textContent = totalDettesAutres.toLocaleString()
    } else {
      dettesCard.style.display = 'none'
      console.log('Aucune dette détaillée trouvée - card cachée')
    }
    
    // Pré-remplir le champ avec le montant recommandé (inclut la dette totale)
    var paiementInput = document.getElementById('paiementMontant')
    paiementInput.value = montantRecommande.toFixed(0)
    
    // Supprimer les anciens écouteurs d'événements
    var newInput = paiementInput.cloneNode(true)
    paiementInput.parentNode.replaceChild(newInput, paiementInput)
    paiementInput = document.getElementById('paiementMontant')
    
    // Ajouter validation du montant de paiement
    paiementInput.addEventListener('input', function() {
      var montantSaisi = parseFloat(this.value) || 0
      var existingWarning = document.getElementById('paiementWarning')
      
      // Supprimer l'ancien avertissement s'il existe
      if (existingWarning) {
        existingWarning.remove()
      }
      
      if (montantSaisi > montantRecommande) {
        var warning = document.createElement('div')
        warning.id = 'paiementWarning'
        warning.className = 'alert alert-info border-0 mt-2'
        warning.innerHTML = `
          <div class="d-flex align-items-center">
            <div class="icon-shape icon-sm bg-gradient-info shadow border-radius-md me-3">
              <i class="material-symbols-rounded text-white text-sm">info</i>
            </div>
            <div>
              <p class="mb-0 text-sm">
                <strong>Attention :</strong> Le montant saisi (${montantSaisi.toLocaleString()} F) dépasse le montant recommandé (${montantRecommande.toLocaleString()} F).<br>
                <small class="text-muted">L'excédent sera considéré comme un paiement anticipé.</small>
              </p>
            </div>
          </div>
        `
        this.closest('.input-group').parentNode.appendChild(warning)
      }
    })
  })

  var modifierModal = document.getElementById('modifierModal')
  modifierModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget
    var venteId = button.getAttribute('data-vente-id')
    var form = document.getElementById('modifierModalForm')
    form.action = '/ventes/' + venteId + '/modifier/'
    // reset container
    var container = document.getElementById('articles-container')
    container.innerHTML = ''
    document.getElementById('total-selected').innerText = '0'
    // Add one article row by default
    document.getElementById('add-article-btn').click()
  })

  // Add article row
  document.getElementById('add-article-btn').addEventListener('click', function(){
    var container = document.getElementById('articles-container')
    var idx = container.children.length
    
    // Générer les options de cahiers comme dans le modal nouvelle vente
    var cahierOptions = '<option value="">-- Sélectionner un cahier --</option>';
    cahiersData.forEach(function(cahier) {
      cahierOptions += `<option data-price="${cahier.prix}" value="${cahier.id}">${cahier.titre} - ${cahier.prix}F</option>`;
    });
    
    var div = document.createElement('div')
    div.className = 'row mb-3'
    div.innerHTML = `
      <div class="col-md-6">
        <div class="input-group input-group-outline">
          <div class="search-select-container">
            <input type="text" class="form-control border border-secondary cahier-search-input-modifier" placeholder="Rechercher un cahier..." autocomplete="off">
            <select name="cahier_${idx}" class="form-control select-cahier border border-secondary" style="display: none;">
              ${cahierOptions}
            </select>
            <div class="dropdown-list cahier-dropdown-modifier">
              <!-- Options dynamiques ici -->
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="input-group input-group-outline">
          <input name="quantite_${idx}" type="number" min="1" value="1" class="form-control border border-secondary qty-input" />
        </div>
      </div>
      <div class="col-md-3 d-flex align-items-center">
        <button type="button" class="btn btn-danger btn-sm btn-remove">
          <i class="material-symbols-rounded">delete</i> Supprimer
        </button>
      </div>
    `
    container.appendChild(div)

    // attach listeners
    var searchInput = div.querySelector('.cahier-search-input-modifier');
    var select = div.querySelector('.select-cahier');
    var dropdown = div.querySelector('.cahier-dropdown-modifier');
    
    // Initialiser le select avec recherche
    if (searchInput && select && dropdown) {
      createSearchableSelect({
        searchInput: searchInput,
        hiddenSelect: select,
        dropdownList: dropdown,
        placeholder: 'Rechercher un cahier...',
        onSelectionChange: function() {
          updateTotal();
        }
      });
    }
    
    select.addEventListener('change', updateTotal)
    div.querySelector('.qty-input').addEventListener('input', updateTotal)
    div.querySelector('.btn-remove').addEventListener('click', function(){ div.remove(); updateTotal() })
    updateTotal()
  })

  function updateTotal(){
    var total = 0
    document.querySelectorAll('#articles-container .row').forEach(function(row){
      var sel = row.querySelector('.select-cahier')
      var opt = sel.options[sel.selectedIndex]
      var price = parseFloat(opt.getAttribute('data-price')) || 0
      var qty = parseInt(row.querySelector('.qty-input').value) || 0
      total += price * qty
    })
    document.getElementById('total-selected').innerText = total.toFixed(0)
  }

  // Submit modifier form: collect articles into JSON 'articles' field
  document.getElementById('modifierModalForm').addEventListener('submit', function(e){
    var container = document.getElementById('articles-container')
    var articles = []
    container.querySelectorAll('.row').forEach(function(row){
      var sel = row.querySelector('.select-cahier')
      var opt = sel.options[sel.selectedIndex]
      var id = sel.value
      var qty = parseInt(row.querySelector('.qty-input').value) || 0
      if (qty > 0) articles.push({cahier_id: id, quantite: qty})
    })
    var input = document.createElement('input')
    input.type = 'hidden'
    input.name = 'articles'
    input.value = JSON.stringify(articles)
    this.appendChild(input)
  })

  // Initialiser les tooltips Bootstrap et la recherche d'école
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"], [title]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // Initialiser le select École de recherche avec la fonction générique
    createSearchableSelect({
      searchInput: document.getElementById('ecoleSearchInput'),
      hiddenSelect: document.getElementById('ecole'),
      dropdownList: document.getElementById('ecoleDropdownList'),
      placeholder: 'Rechercher une école...'
    });
  })
</script>

<!-- Modal Nouvelle Vente -->
<div class="modal fade" id="modalNouvelleVente" tabindex="-1" aria-labelledby="modalNouvelleVenteLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalNouvelleVenteLabel">
          <i class="material-symbols-rounded me-2">add_shopping_cart</i>
          Créer une nouvelle vente
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <form id="formNouvelleVente" method="post" action="{% url 'creer_vente' %}">
        {% csrf_token %}
        <div class="modal-body">
          <!-- Sélection école -->
          <div class="row mb-4">
            <div class="col-md-12">
              <label for="nouvelle_vente_ecole_search" class="form-label">École <span class="text-danger">*</span></label>
              <div class="search-select-container">
                <input type="text" id="nouvelle_vente_ecole_search" class="form-control border border-secondary" placeholder="Rechercher une école..." autocomplete="off" required>
                <select name="ecole_id" id="nouvelle_vente_ecole" style="display: none;" required>
                  <option value="">-- Sélectionner une école --</option>
                  {% for ecole in ecoles %}
                    <option value="{{ ecole.id }}">{{ ecole.nom }}</option>
                  {% endfor %}
                </select>
                <div id="nouvelle_vente_ecole_dropdown" class="dropdown-list">
                  <!-- Options dynamiques ici -->
                </div>
              </div>
            </div>
          </div>

          <hr class="horizontal dark">

        <!-- Sélection des articles -->
          <div class="row">
            <div class="col-12">
              <h6 class="text-dark font-weight-bolder mb-3">
                <i class="material-symbols-rounded me-2">inventory_2</i>
                Articles à ajouter
              </h6>
              
              <div id="articles_container">
                <div class="article-row row mb-3">
                  <div class="col-md-6">
                    <label class="form-label">Cahier</label>
                    <div class="search-select-container">
                      <input type="text" class="form-control border border-secondary cahier-search-input" placeholder="Rechercher un cahier..." autocomplete="off">
                      <select name="articles[0][cahier_id]" class="form-select border border-secondary cahier-select" style="display: none;">
                        <option value="" data-prix="0">-- Sélectionner un cahier --</option>
                        {% for cahier in cahiers %}
                          <option value="{{ cahier.id }}" data-prix="{{ cahier.prix }}">{{ cahier.titre }} - {{ cahier.prix|floatformat:0 }}F</option>
                        {% endfor %}
                      </select>
                      <div class="dropdown-list cahier-dropdown">
                        <!-- Options dynamiques ici -->
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Quantité</label>
                    <input type="number" min="1" value="1" name="articles[0][quantite]" class="form-control border border-secondary" placeholder="1">
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-article" disabled>
                      <i class="material-symbols-rounded">remove</i>
                    </button>
                  </div>
                </div>
              </div>
              
              <button type="button" id="addArticleBtn" class="btn btn-outline-primary btn-sm">
                <i class="material-symbols-rounded me-1">add</i>
                Ajouter un article
              </button>
            </div>
          </div>

          <!-- Récapitulatif -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">Récapitulatif</h6>
                  <div class="d-flex justify-content-between">
                    <span>Montant articles:</span>
                    <span id="montant_articles">0 F</span>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span>Dette précédente:</span>
                    <span id="montant_dette">0 F</span>
                  </div>
                  <hr>
                  <div class="d-flex justify-content-between fw-bold">
                    <span>Total:</span>
                    <span id="montant_total">0 F</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">
            <i class="material-symbols-rounded me-1">save</i>
            Créer la vente
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Données des cahiers pour le JavaScript
  const cahiersData = [
    {% for cahier in cahiers %}
      {id: '{{ cahier.id }}', titre: '{{ cahier.titre }}', prix: {{ cahier.prix }}},
    {% endfor %}
  ];
  
  // Gestion du modal nouvelle vente
  document.addEventListener('DOMContentLoaded', function() {
    let articleIndex = 1; // Commence à 1 car le premier article [0] est déjà présent
    
    // Fonction pour générer les options de cahiers
    function generateCahierOptions() {
      let options = '<option value="">-- Sélectionner un cahier --</option>';
      cahiersData.forEach(cahier => {
        options += `<option value="${cahier.id}" data-prix="${cahier.prix}">${cahier.titre} - ${cahier.prix}F</option>`;
      });
      return options;
    }
    
    // Fonction pour mettre à jour le récapitulatif
    function updateRecapitulatif() {
      let montantArticles = 0;
      const rows = document.querySelectorAll('.article-row');
      
      rows.forEach(row => {
        const select = row.querySelector('select');
        const quantiteInput = row.querySelector('input[type="number"]');
        
        if (select && select.value && quantiteInput && quantiteInput.value) {
          const selectedOption = select.selectedOptions[0];
          const prix = parseFloat(selectedOption?.dataset?.prix || 0);
          const quantite = parseInt(quantiteInput.value || 0);
          if (prix > 0 && quantite > 0) {
            montantArticles += prix * quantite;
          }
        }
      });
      
      const detteInput = document.getElementById('nouvelle_vente_dette');
      const dette = parseFloat(detteInput?.value || 0);
      const total = montantArticles + dette;
      
      const montantArticlesEl = document.getElementById('montant_articles');
      const montantDetteEl = document.getElementById('montant_dette');
      const montantTotalEl = document.getElementById('montant_total');
      
      if (montantArticlesEl) montantArticlesEl.textContent = montantArticles.toFixed(0) + ' F';
      if (montantDetteEl) montantDetteEl.textContent = dette.toFixed(0) + ' F';
      if (montantTotalEl) montantTotalEl.textContent = total.toFixed(0) + ' F';
    }
    
    // Fonction pour mettre à jour les boutons de suppression
    function updateRemoveButtons() {
      const removeButtons = document.querySelectorAll('.remove-article');
      removeButtons.forEach((btn) => {
        btn.disabled = removeButtons.length <= 1;
      });
    }
    
    // Fonction pour attacher les événements à une ligne d'article
    function attachArticleEvents(row) {
      const select = row.querySelector('.cahier-select');
      const searchInput = row.querySelector('.cahier-search-input');
      const dropdownList = row.querySelector('.cahier-dropdown');
      const quantiteInput = row.querySelector('input[type="number"]');
      const removeBtn = row.querySelector('.remove-article');
      
      // Initialiser le select avec recherche
      if (searchInput && select && dropdownList) {
        var searchableSelect = createSearchableSelect({
          searchInput: searchInput,
          hiddenSelect: select,
          dropdownList: dropdownList,
          placeholder: 'Rechercher un cahier...',
          onSelectionChange: function(option) {
            updateRecapitulatif();
          }
        });
      }
      
      if (select) {
        select.addEventListener('change', updateRecapitulatif);
      }
      
      if (quantiteInput) {
        quantiteInput.addEventListener('input', updateRecapitulatif);
      }
      
      if (removeBtn) {
        removeBtn.addEventListener('click', function() {
          row.remove();
          updateRemoveButtons();
          updateRecapitulatif();
        });
      }
    }
    
    // Initialiser les événements pour le premier article existant
    const firstArticleRow = document.querySelector('.article-row');
    if (firstArticleRow) {
      attachArticleEvents(firstArticleRow);
    }
    
    // Ajouter l'événement pour le champ dette
    const detteInput = document.getElementById('nouvelle_vente_dette');
    if (detteInput) {
      detteInput.addEventListener('input', updateRecapitulatif);
    }
    
    // Initialiser les boutons de suppression
    updateRemoveButtons();
    
    // Calculer le récapitulatif initial
    updateRecapitulatif();
    
    // Ajouter un article
    const addArticleBtn = document.getElementById('addArticleBtn');
    if (addArticleBtn) {
      addArticleBtn.addEventListener('click', function() {
        const container = document.getElementById('articles_container');
        if (!container) return;
        
        const newRow = document.createElement('div');
        newRow.className = 'article-row row mb-3';
        newRow.innerHTML = `
          <div class="col-md-6">
            <label class="form-label">Cahier</label>
            <div class="search-select-container">
              <input type="text" class="form-control border border-secondary cahier-search-input" placeholder="Rechercher un cahier..." autocomplete="off">
              <select name="articles[${articleIndex}][cahier_id]" class="form-select border border-secondary cahier-select" style="display: none;">
                ${generateCahierOptions()}
              </select>
              <div class="dropdown-list cahier-dropdown">
                <!-- Options dynamiques ici -->
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Quantité</label>
            <input type="number" min="1" value="1" name="articles[${articleIndex}][quantite]" class="form-control border border-secondary" placeholder="1">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="button" class="btn btn-outline-danger btn-sm remove-article">
              <i class="material-symbols-rounded">remove</i>
            </button>
          </div>
        `;
        
        container.appendChild(newRow);
        articleIndex++;
        
        // Attacher les événements à la nouvelle ligne
        attachArticleEvents(newRow);
        
        updateRemoveButtons();
        updateRecapitulatif();
      });
    }
    
    // Gérer la soumission du formulaire de création de vente
    const nouvelleVenteForm = document.getElementById('formNouvelleVente');
    if (nouvelleVenteForm) {
      nouvelleVenteForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validation : au moins un article
        const rows = document.querySelectorAll('.article-row');
        let articles = [];
        
        rows.forEach(row => {
          const select = row.querySelector('select');
          const quantiteInput = row.querySelector('input[type="number"]');
          
          if (select && select.value && quantiteInput && quantiteInput.value && parseInt(quantiteInput.value) > 0) {
            articles.push({
              cahier_id: select.value,
              quantite: parseInt(quantiteInput.value)
            });
          }
        });
        
        if (articles.length === 0) {
          alert('Veuillez ajouter au moins un article avec une quantité valide.');
          return;
        }
        
        // Préparer les données du formulaire
        const formData = new FormData(nouvelleVenteForm);
        
        // Ajouter les articles en JSON
        formData.append('articles', JSON.stringify(articles));
        
        // Désactiver le bouton et afficher un indicateur de chargement
        const submitBtn = document.querySelector('#modalNouvelleVente .btn-primary');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="material-symbols-rounded">hourglass_empty</i> Création...';
        
        // Envoyer la requête
        fetch('{% url "creer_vente" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Fermer le modal
            const modalElement = document.getElementById('modalNouvelleVente');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
              modal.hide();
            }
            
            // Afficher un message de succès
            if (data.message) {
              alert(data.message);
            }
            
            // Rediriger vers la page de détail de la vente ou recharger la liste
            if (data.redirect_url) {
              window.location.href = data.redirect_url;
            } else {
              window.location.reload();
            }
          } else {
            // Afficher l'erreur
            alert('Erreur : ' + (data.error || 'Une erreur s\'est produite'));
          }
        })
        .catch(error => {
          console.error('Erreur:', error);
          alert('Erreur de communication avec le serveur');
        })
        .finally(() => {
          // Réactiver le bouton
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        });
      });
    }
    
    // Réinitialiser le modal à chaque ouverture
    const modalElement = document.getElementById('modalNouvelleVente');
    if (modalElement) {
      modalElement.addEventListener('show.bs.modal', function () {
        // Réinitialiser le formulaire
        const form = document.getElementById('formNouvelleVente');
        if (form) {
          form.reset();
        }
        
        // Réinitialiser le container d'articles avec un seul article
        const container = document.getElementById('articles_container');
        if (container) {
          container.innerHTML = `
            <div class="article-row row mb-3">
              <div class="col-md-6">
                <label class="form-label">Cahier</label>
                <div class="search-select-container">
                  <input type="text" class="form-control border border-secondary cahier-search-input" placeholder="Rechercher un cahier..." autocomplete="off">
                  <select name="articles[0][cahier_id]" class="form-select border border-secondary cahier-select" style="display: none;">
                    ${generateCahierOptions()}
                  </select>
                  <div class="dropdown-list cahier-dropdown">
                    <!-- Options dynamiques ici -->
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Quantité</label>
                <input type="number" min="1" value="1" name="articles[0][quantite]" class="form-control border border-secondary" placeholder="1">
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger btn-sm remove-article" disabled>
                  <i class="material-symbols-rounded">remove</i>
                </button>
              </div>
            </div>
          `;
          
          // Réattacher les événements au premier article
          const firstRow = container.querySelector('.article-row');
          if (firstRow) {
            attachArticleEvents(firstRow);
          }
        }
        
        // Réinitialiser l'index des articles
        articleIndex = 1;
        
        // Mettre à jour les boutons et le récapitulatif
        updateRemoveButtons();
        updateRecapitulatif();
        
        // Initialiser le select École avec recherche
        var nouvelleVenteEcoleSearch = createSearchableSelect({
          searchInput: document.getElementById('nouvelle_vente_ecole_search'),
          hiddenSelect: document.getElementById('nouvelle_vente_ecole'),
          dropdownList: document.getElementById('nouvelle_vente_ecole_dropdown'),
          placeholder: 'Rechercher une école...'
        });
      });
    }
  });
</script>
<script>
  var retirerModal = document.getElementById('retirerModal')
retirerModal.addEventListener('show.bs.modal', function (event) {
  var button = event.relatedTarget
  var venteId = button.getAttribute('data-vente-id')
  var form = document.getElementById('retirerModalForm')
  form.action = '/ventes/' + venteId + '/retirer/'
  var container = document.getElementById('retirer-articles-container')
  container.innerHTML = ''
  // Charger les cahiers de la vente via AJAX
  fetch('/ventes/' + venteId + '/cahiers/')
    .then(response => response.json())
    .then(data => {
      data.lignes.forEach(function(ligne, idx){
        var div = document.createElement('div')
        div.className = 'row mb-3'
        div.innerHTML = `
          <div class="col-md-6">
            <div class="input-group input-group-outline">
              <input type="text" class="form-control border border-secondary" value="${ligne.cahier_titre}" readonly />
              <input type="hidden" name="cahier_${idx}" value="${ligne.cahier_id}" />
            </div>
          </div>
          <div class="col-md-3">
            <div class="input-group input-group-outline">
              <input name="quantite_${idx}" type="number" min="0" max="${ligne.quantite}" value="0" class="form-control border border-secondary" />
            </div>
          </div>
        `
        container.appendChild(div)
      })
    })
})
</script>

<!-- Modal de suppression de vente -->
<div class="modal fade" id="supprimerVenteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-secondary">
        <h5 class="modal-title text-white font-weight-bolder">
          Confirmer la suppression
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <h5 class="text-dark mb-3">Êtes-vous sûr de vouloir supprimer cette vente ?</h5>
          <div class="alert alert-light border-0" role="alert">
            <div class="d-flex align-items-start">
              <div class="text-start">
                <p class="mb-2"><strong>Informations de la vente :</strong></p>
                <ul class="list-unstyled mb-2">
                  <li><strong>École :</strong> <span id="supprimerVenteEcole"></span></li>
                  <li><strong>Date :</strong> <span id="supprimerVenteDate"></span></li>
                  <li><strong>Montant :</strong> <span id="supprimerVenteMontant"></span> F</li>
                </ul>
                <p class="text-sm mb-0">
                  <i class="material-symbols-rounded text-xs me-1">warning</i>
                  <strong>Attention :</strong> Cette action est irréversible. Tous les articles et paiements associés seront également supprimés.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="material-symbols-rounded me-1">close</i>
          Annuler
        </button>
        <form id="supprimerVenteForm" method="post" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn bg-gradient-danger shadow">
            <i class="material-symbols-rounded me-1">delete_forever</i>
            Supprimer définitivement
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Gestion du modal de suppression de vente
  var supprimerVenteModal = document.getElementById('supprimerVenteModal')
  if (supprimerVenteModal) {
    supprimerVenteModal.addEventListener('show.bs.modal', function (event) {
      var button = event.relatedTarget
      var venteId = button.getAttribute('data-vente-id')
      var venteEcole = button.getAttribute('data-vente-ecole')
      var venteMontant = button.getAttribute('data-vente-montant')
      var venteDate = button.getAttribute('data-vente-date')
      
      // Remplir les informations dans le modal
      document.getElementById('supprimerVenteEcole').textContent = venteEcole || 'N/A'
      document.getElementById('supprimerVenteDate').textContent = venteDate || 'N/A'
      document.getElementById('supprimerVenteMontant').textContent = venteMontant || '0'
      
      // Mettre à jour l'action du formulaire
      var form = document.getElementById('supprimerVenteForm')
      form.action = '/vente/' + venteId + '/supprimer/'
    })
  }
</script>

{% endblock %}
