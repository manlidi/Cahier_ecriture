{% extends 'base.html' %}
{% block content %}
{% load static %}
<div class="container-fluid py-3">
  <!-- Header Section -->
  <div class="row align-items-center mb-4">
    <div class="col-md-8">
      <div class="d-flex align-items-center">
        <div class="icon-shape icon-lg bg-gradient-secondary shadow border-radius-xl me-3">
          <i class="material-symbols-rounded text-white" style="font-size: 2rem;">point_of_sale</i>
        </div>
        <div>
          <h3 class="mb-0 font-weight-bolder text-dark">Gestion des Ventes</h3>
          <p class="mb-0 text-muted">Suivi et administration de toutes les transactions</p>
        </div>
      </div>
    </div>
    <div class="col-md-4 text-end">
      <button type="button" class="btn bg-gradient-secondary btn-lg shadow-primary" data-bs-toggle="modal" data-bs-target="#modalNouvelleVente">
        <i class="material-symbols-rounded me-2">add_circle</i>
        Nouvelle Vente
      </button>
    </div>
  </div>

  <!-- Filters Card -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient-light p-3">
          <div class="row align-items-center">
            <div class="col">
              <h6 class="mb-0 text-dark font-weight-bolder">
                <i class="material-symbols-rounded me-2">filter_list</i>
                Filtres de recherche
              </h6>
            </div>
          </div>
        </div>
        <div class="card-body p-4">
          <form method="get" class="row g-3">
            <div class="col-lg-8 col-md-8">
              <div class="input-group input-group-outline">
                <label class="form-label">École</label>
                <select name="ecole" id="ecole" class="form-control border border-secondary">
                  <option value=""></option>
                  {% for e in ecoles %}
                    <option value="{{ e.id }}" {% if selected_ecole == e.id|stringformat:'s' %}selected{% endif %}>{{ e.nom }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-lg-4 col-md-4 d-flex align-items-end">
              <button type="submit" class="btn bg-gradient-info w-100 shadow">
                <i class="material-symbols-rounded me-2">search</i>
                Appliquer le filtre
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Sales List Card -->
  <div class="row">
    <div class="col-12">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient-secondary p-3">
          <div class="row align-items-center">
            <div class="col">
              <h6 class="mb-0 text-white font-weight-bolder">
                <i class="material-symbols-rounded me-2">receipt_long</i>
                Liste des ventes
                {% if ventes %}
                  <span class="badge bg-light text-dark ms-2">{{ ventes.paginator.count }} vente{{ ventes.paginator.count|pluralize }}</span>
                {% endif %}
              </h6>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          {% if ventes %}
            <div class="table-responsive">
              <table class="table align-items-center mb-0">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-4">Vente</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">École</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Montants</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Statut</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Articles</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for v in ventes %}
                    <tr class="border-bottom">
                      <td class="ps-4">
                        <div class="d-flex align-items-center">
                          <div class="icon-shape icon-sm bg-gradient-secondary shadow border-radius-md me-3">
                            <i class="material-symbols-rounded text-white">receipt</i>
                          </div>
                          <div>
                            <h6 class="mb-0 text-sm font-weight-bold">{{ v.short_id }}</h6>
                            <p class="text-xs text-muted mb-0">{{ v.created_at.date|date:"d/m/Y" }}</p>
                            <small class="text-xs text-info">{{ v.annee_scolaire }}</small>
                          </div>
                        </div>
                      </td>
                      <td>
                        <div>
                          <h6 class="mb-0 text-sm font-weight-bold">{{ v.ecole.nom }}</h6>
                          <p class="text-xs text-muted mb-0">{{ v.created_at|date:"H:i" }}</p>
                        </div>
                      </td>
                      <td>
                        <div class="d-flex flex-column">
                          <span class="text-sm font-weight-bold text-dark">Total: {{ v.montant_total|floatformat:0 }} F</span>
                          <span class="text-xs text-success">Payé: {{ v.montant_paye|floatformat:0 }} F</span>
                          <span class="text-xs {% if v.montant_restant > 0 %}text-warning{% else %}text-muted{% endif %}">
                            Restant: {{ v.montant_restant|floatformat:0 }} F
                          </span>
                        </div>
                      </td>
                      <td>
                        {% if v.montant_restant <= 0 %}
                          <span class="badge badge-sm bg-gradient-success">
                            <i class="material-symbols-rounded text-xs me-1">check_circle</i>
                            Payé
                          </span>
                        {% elif v.montant_paye > 0 %}
                          <span class="badge badge-sm bg-gradient-warning">
                            <i class="material-symbols-rounded text-xs me-1">schedule</i>
                            Partiel
                          </span>
                        {% else %}
                          <span class="badge badge-sm bg-gradient-danger">
                            <i class="material-symbols-rounded text-xs me-1">error</i>
                            Impayé
                          </span>
                        {% endif %}
                      </td>
                      <td>
                        <div class="d-flex align-items-center">
                          <div class="icon-shape icon-xs bg-gradient-info shadow border-radius-sm me-2">
                            <i class="material-symbols-rounded text-white text-xs">inventory</i>
                          </div>
                          <span class="text-sm font-weight-bold">{{ v.lignes_count }}</span>
                        </div>
                      </td>
                      <td class="text-center">
                        <div class="d-flex justify-content-center gap-1">
                          <!-- Bouton Détails -->
                          <a class="btn btn-link text-info p-2 mb-0" href="{% url 'vente_detail' v.id %}" 
                             title="Voir les détails" data-bs-toggle="tooltip">
                            <i class="material-symbols-rounded text-sm">visibility</i>
                          </a>
                          
                          <!-- Bouton Facture PDF -->
                          <a class="btn btn-link text-secondary p-2 mb-0" href="{% url 'generer_facture_pdf' v.id %}" 
                             title="Générer la facture PDF" data-bs-toggle="tooltip" target="_blank">
                            <i class="material-symbols-rounded text-sm">description</i>
                          </a>
                          
                          <!-- Bouton Paiement -->
                          {% if v.montant_restant > 0 %}
                          <button class="btn btn-link text-success p-2 mb-0" data-bs-toggle="modal" data-bs-target="#paiementModal" 
                                  title="Ajouter un paiement" data-bs-toggle="tooltip"
                                  data-vente-id="{{ v.id }}" 
                                  data-montant-total="{{ v.montant_total }}"
                                  data-montant-paye="{{ v.montant_paye }}"
                                  data-montant-restant="{{ v.montant_restant }}"
                                  data-ecole-nom="{{ v.ecole.nom }}"
                                  data-annee="{{ v.annee_scolaire }}"
                                  data-dettes-autres='{{ v.dettes_autres_json }}'
                                  data-total-dettes-autres="{{ v.total_dettes_autres }}">
                            <i class="material-symbols-rounded text-sm">payments</i>
                          </button>
                          {% endif %}
                          
                          <!-- Bouton Ajouter article -->
                          {% if v.annee_scolaire.est_active %}
                          <button class="btn btn-link text-warning p-2 mb-0" data-bs-toggle="modal" data-bs-target="#modifierModal" 
                                  title="Ajouter un article" data-bs-toggle="tooltip"
                                  data-vente-id="{{ v.id }}">
                            <i class="material-symbols-rounded text-sm">add_shopping_cart</i>
                          </button>
                          {% endif %}

                          <button class="btn btn-link text-danger p-2 mb-0" data-bs-toggle="modal" data-bs-target="#retirerModal"
                                  title="Retirer des cahiers" data-bs-toggle="tooltip"
                                  data-vente-id="{{ v.id }}">
                            <i class="material-symbols-rounded text-sm">remove_shopping_cart</i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center p-5">
              <div class="icon-shape icon-xxl bg-gradient-light shadow border-radius-xl mx-auto mb-3">
                <i class="material-symbols-rounded text-muted" style="font-size: 3rem;">receipt_long</i>
              </div>
              <h5 class="text-muted mb-2">Aucune vente trouvée</h5>
              <p class="text-sm text-muted mb-4">Il n'y a pas de ventes correspondant à vos critères de recherche.</p>
              <button type="button" class="btn bg-gradient-primary" data-bs-toggle="modal" data-bs-target="#modalNouvelleVente">
                <i class="material-symbols-rounded me-2">add_circle</i>
                Créer la première vente
              </button>
            </div>
          {% endif %}
          
          <!-- Pagination -->
          {% if ventes.has_other_pages %}
          <div class="d-flex justify-content-center p-4 border-top">
            <nav aria-label="Navigation des pages">
              <ul class="pagination pagination-primary">
                {% if ventes.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?{% if selected_ecole %}ecole={{ selected_ecole }}&{% endif %}page={{ ventes.previous_page_number }}">
                      <i class="material-symbols-rounded">chevron_left</i>
                    </a>
                  </li>
                {% endif %}
                
                {% for page_num in ventes.paginator.page_range %}
                  {% if page_num == ventes.number %}
                    <li class="page-item active">
                      <span class="page-link">{{ page_num }}</span>
                    </li>
                  {% elif page_num == 1 or page_num == ventes.paginator.num_pages or page_num >= ventes.number|add:'-2' and page_num <= ventes.number|add:'2' %}
                    <li class="page-item">
                      <a class="page-link" href="?{% if selected_ecole %}ecole={{ selected_ecole }}&{% endif %}page={{ page_num }}">{{ page_num }}</a>
                    </li>
                  {% elif page_num == 2 and ventes.number > 4 %}
                    <li class="page-item disabled">
                      <span class="page-link">...</span>
                    </li>
                  {% elif page_num == ventes.paginator.num_pages|add:'-1' and ventes.number < ventes.paginator.num_pages|add:'-3' %}
                    <li class="page-item disabled">
                      <span class="page-link">...</span>
                    </li>
                  {% endif %}
                {% endfor %}
                
                {% if ventes.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?{% if selected_ecole %}ecole={{ selected_ecole }}&{% endif %}page={{ ventes.next_page_number }}">
                      <i class="material-symbols-rounded">chevron_right</i>
                    </a>
                  </li>
                {% endif %}
              </ul>
            </nav>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Retirer Modal -->
<div class="modal fade" id="retirerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Retirer des cahiers de la vente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="retirerModalForm" method="post">
        {% csrf_token %}
        <div class="modal-body">
          <div id="retirer-articles-container"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-danger">Retirer</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Paiement Modal -->
<div class="modal fade" id="paiementModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ajouter un paiement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Informations de la vente courante -->
        <div class="card mb-3">
          <div class="card-header pb-0">
            <h6 class="text-dark font-weight-bolder">Facture courante - <span id="venteEcoleNom"></span> (<span id="venteAnnee"></span>)</h6>
          </div>
          <div class="card-body pt-2">
            <div class="row">
              <div class="col-md-4">
                <div class="info-item">
                  <p class="text-sm text-muted mb-1">Montant total de la facture</p>
                  <h6 class="font-weight-bolder text-dark mb-0"><span id="venteMontantTotal"></span> F</h6>
                </div>
              </div>
              <div class="col-md-4">
                <div class="info-item">
                  <p class="text-sm text-muted mb-1">Montant déjà payé</p>
                  <h6 class="font-weight-bolder text-success mb-0"><span id="venteMontantPaye"></span> F</h6>
                </div>
              </div>
              <div class="col-md-4">
                <div class="info-item">
                  <p class="text-sm text-muted mb-1">Montant restant</p>
                  <h6 class="font-weight-bolder text-warning mb-0"><span id="venteMontantRestant"></span> F</h6>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Dettes des autres années -->
        <div class="card mb-3" id="dettesAutresCard" style="display:none;">
          <div class="card-header pb-0">
            <h6 class="text-dark font-weight-bolder">Dettes précédentes</h6>
          </div>
          <div class="card-body pt-2">
            <div id="dettesAutresList"></div>
            <hr class="horizontal dark">
            <div class="row">
              <div class="col-12">
                <div class="info-item">
                  <p class="text-sm text-muted mb-1">Total des dettes précédentes</p>
                  <h6 class="font-weight-bolder text-danger mb-0"><span id="totalDettesAutres"></span> F</h6>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Récapitulatif total -->
        <div class="card mb-3">
          <div class="card-header pb-0">
            <h6 class="text-dark font-weight-bolder">Récapitulatif général</h6>
          </div>
          <div class="card-body pt-2">
            <div class="row">
              <div class="col-md-6">
                <div class="info-item">
                  <p class="text-sm text-muted mb-1">Total général à payer</p>
                  <h5 class="font-weight-bolder text-primary mb-0"><span id="totalGeneral"></span> F</h5>
                </div>
              </div>
              <div class="col-md-6">
                <div class="info-item">
                  <p class="text-sm text-muted mb-1">Montant recommandé</p>
                  <h5 class="font-weight-bolder text-info mb-0"><span id="montantRecommande"></span> F</h5>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Formulaire de paiement -->
        <form id="paiementModalForm" method="post">
          {% csrf_token %}
          <div class="row">
            <div class="col-12">
              <div class="input-group input-group-outline mb-3">
                <label class="form-label">Montant du paiement</label>
                <input class="form-control" name="montant" id="paiementMontant" type="number" step="0.01" required />
              </div>
            </div>
          </div>
          
          <!-- Note d'information -->
          <div class="alert alert-info alert-dismissible text-white mb-3" role="alert">
            <span class="alert-icon align-middle">
              <i class="material-symbols-rounded">info</i>
            </span>
            <span class="alert-text">
              <strong>Note :</strong> Si le montant saisi dépasse le solde de cette vente, l'excédent sera automatiquement appliqué aux dettes des autres années de la même école, en commençant par la plus récente.
            </span>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" form="paiementModalForm" class="btn btn-primary">Enregistrer le paiement</button>
      </div>
    </div>
  </div>
</div>

<!-- Modifier Modal -->
<div class="modal fade" id="modifierModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ajouter des articles à la vente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="modifierModalForm" method="post">
        {% csrf_token %}
        <div class="modal-body">
          <div id="articles-container">
            <!-- template ligne article -->
          </div>
          <div class="d-flex justify-content-between align-items-center mt-3">
            <button id="add-article-btn" type="button" class="btn btn-outline-primary">
              <i class="material-symbols-rounded">add</i> Ajouter un article
            </button>
            <div class="card">
              <div class="card-body p-2">
                <p class="text-sm mb-0">Prix total sélection</p>
                <h5 class="font-weight-bolder mb-0"><span id="total-selected">0</span> F</h5>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Ajouter à la vente</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
  // Using Bootstrap 5 modal events
  var paiementModal = document.getElementById('paiementModal')
  paiementModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget
    var venteId = button.getAttribute('data-vente-id')
    var montantTotal = parseFloat(button.getAttribute('data-montant-total')) || 0
    var montantPaye = parseFloat(button.getAttribute('data-montant-paye')) || 0
    var montantRestant = parseFloat(button.getAttribute('data-montant-restant')) || 0
    var ecoleNom = button.getAttribute('data-ecole-nom') || ''
    var annee = button.getAttribute('data-annee') || ''
    var dettesAutresData = button.getAttribute('data-dettes-autres') || '[]'
    var totalDettesAutres = parseFloat(button.getAttribute('data-total-dettes-autres')) || 0
    
    console.log('Raw dettesAutresData:', dettesAutresData)
    console.log('Type of dettesAutresData:', typeof dettesAutresData)
    console.log('Modal data:', {montantTotal, montantPaye, montantRestant, dettesAutresData, totalDettesAutres})
    console.log('Parsed dettes:', dettesAutres)
    
    var form = document.getElementById('paiementModalForm')
    form.action = '/ventes/' + venteId + '/paiement/'
    
    // Remplir les informations de la vente courante
    document.getElementById('venteEcoleNom').textContent = ecoleNom
    document.getElementById('venteAnnee').textContent = annee
    document.getElementById('venteMontantTotal').textContent = montantTotal.toFixed(0)
    document.getElementById('venteMontantPaye').textContent = montantPaye.toFixed(0)
    document.getElementById('venteMontantRestant').textContent = montantRestant.toFixed(0)
    
    // Parse dettes autres
    var dettesAutres = []
    try {
      dettesAutres = JSON.parse(dettesAutresData)
    } catch(e) {
      console.error('Error parsing dettes:', e)
    }
    
    // Afficher les dettes des autres années
    var dettesCard = document.getElementById('dettesAutresCard')
    var dettesList = document.getElementById('dettesAutresList')
    
    console.log('Dettes autres length:', dettesAutres.length)
    
    if (dettesAutres.length > 0) {
      dettesCard.style.display = 'block'
      dettesList.innerHTML = ''
      
      dettesAutres.forEach(function(dette, index) {
        console.log('Dette', index, ':', dette)
        var div = document.createElement('div')
        div.className = 'row mb-2'
        div.innerHTML = `
          <div class="col-8">
            <p class="text-sm mb-0">${dette.annee_scolaire}</p>
          </div>
          <div class="col-4 text-end">
            <span class="text-danger font-weight-bolder">${parseFloat(dette.montant_restant).toFixed(0)} F</span>
          </div>
        `
        dettesList.appendChild(div)
      })
      
      document.getElementById('totalDettesAutres').textContent = totalDettesAutres.toFixed(0)
    } else {
      dettesCard.style.display = 'none'
      totalDettesAutres = 0
      console.log('Aucune dette trouvée - card cachée')
    }
    
    // Calculs du récapitulatif
    var totalGeneral = montantRestant + totalDettesAutres
    var montantRecommande = totalGeneral
    
    document.getElementById('totalGeneral').textContent = totalGeneral.toFixed(0)
    document.getElementById('montantRecommande').textContent = montantRecommande.toFixed(0)
    
    // Pré-remplir le montant recommandé et définir le maximum
    var paiementInput = document.getElementById('paiementMontant')
    paiementInput.value = montantRecommande.toFixed(0)
    paiementInput.max = montantRecommande + 1 // Limiter le montant maximum
    
    // Ajouter un événement pour vérifier le montant saisi
    paiementInput.addEventListener('input', function() {
      var montantSaisi = parseFloat(this.value) || 0
      var warningDiv = document.getElementById('paiementWarning')
      
      if (montantSaisi > montantRecommande) {
        if (!warningDiv) {
          var warning = document.createElement('div')
          warning.id = 'paiementWarning'
          warning.className = 'alert alert-warning mt-2'
          warning.innerHTML = `
            <span class="alert-icon align-middle">
              <i class="material-symbols-rounded">warning</i>
            </span>
            <span class="alert-text">
              Le montant saisi dépasse le total dû (${montantRecommande.toFixed(0)} F). 
              L'excédent sera rendu à l'utilisateur.
            </span>
          `
          this.parentNode.appendChild(warning)
        }
      } else {
        if (warningDiv) {
          warningDiv.remove()
        }
      }
    })
  })

  var modifierModal = document.getElementById('modifierModal')
  modifierModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget
    var venteId = button.getAttribute('data-vente-id')
    var form = document.getElementById('modifierModalForm')
    form.action = '/ventes/' + venteId + '/modifier/'
    // reset container
    var container = document.getElementById('articles-container')
    container.innerHTML = ''
    document.getElementById('total-selected').innerText = '0'
    // Add one article row by default
    document.getElementById('add-article-btn').click()
  })

  // Add article row
  document.getElementById('add-article-btn').addEventListener('click', function(){
    var container = document.getElementById('articles-container')
    var idx = container.children.length
    var div = document.createElement('div')
    div.className = 'row mb-3'
    div.innerHTML = `
      <div class="col-md-6">
        <div class="input-group input-group-outline">
          <select name="cahier_${idx}" class="form-control select-cahier border border-secondary">
            {% for c in cahiers %}
              <option data-price="{{ c.prix }}" value="{{ c.id }}">{{ c.titre }} - {{ c.prix }} F (stock: {{ c.quantite_stock }})</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="col-md-3">
        <div class="input-group input-group-outline">
          <input name="quantite_${idx}" type="number" min="1" value="1" class="form-control border border-secondary qty-input" />
        </div>
      </div>
      <div class="col-md-3 d-flex align-items-center">
        <button type="button" class="btn btn-danger btn-sm btn-remove">
          <i class="material-symbols-rounded">delete</i> Supprimer
        </button>
      </div>
    `
    container.appendChild(div)

    // attach listeners
    div.querySelector('.select-cahier').addEventListener('change', updateTotal)
    div.querySelector('.qty-input').addEventListener('input', updateTotal)
    div.querySelector('.btn-remove').addEventListener('click', function(){ div.remove(); updateTotal() })
    updateTotal()
  })

  function updateTotal(){
    var total = 0
    document.querySelectorAll('#articles-container .row').forEach(function(row){
      var sel = row.querySelector('.select-cahier')
      var opt = sel.options[sel.selectedIndex]
      var price = parseFloat(opt.getAttribute('data-price')) || 0
      var qty = parseInt(row.querySelector('.qty-input').value) || 0
      total += price * qty
    })
    document.getElementById('total-selected').innerText = total.toFixed(0)
  }

  // Submit modifier form: collect articles into JSON 'articles' field
  document.getElementById('modifierModalForm').addEventListener('submit', function(e){
    var container = document.getElementById('articles-container')
    var articles = []
    container.querySelectorAll('.row').forEach(function(row){
      var sel = row.querySelector('.select-cahier')
      var opt = sel.options[sel.selectedIndex]
      var id = sel.value
      var qty = parseInt(row.querySelector('.qty-input').value) || 0
      if (qty > 0) articles.push({cahier_id: id, quantite: qty})
    })
    var input = document.createElement('input')
    input.type = 'hidden'
    input.name = 'articles'
    input.value = JSON.stringify(articles)
    this.appendChild(input)
  })

  // Initialiser les tooltips Bootstrap
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"], [title]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
  })
</script>

<!-- Modal Nouvelle Vente -->
<div class="modal fade" id="modalNouvelleVente" tabindex="-1" aria-labelledby="modalNouvelleVenteLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalNouvelleVenteLabel">
          <i class="material-symbols-rounded me-2">add_shopping_cart</i>
          Créer une nouvelle vente
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <form id="formNouvelleVente" method="post" action="{% url 'creer_vente' %}">
        {% csrf_token %}
        <div class="modal-body">
          <!-- Sélection école -->
          <div class="row mb-4">
            <div class="col-md-12">
              <label for="nouvelle_vente_ecole" class="form-label">École <span class="text-danger">*</span></label>
              <select name="ecole_id" id="nouvelle_vente_ecole" class="form-select p-2 border border-secondary" required>
                {% for ecole in ecoles %}
                  <option value="{{ ecole.id }}">{{ ecole.nom }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Description (optionnel) -->
          <div class="row mb-4">
            <div class="col-md-12">
              <label for="nouvelle_vente_description" class="form-label">Description (optionnel)</label>
              <textarea name="description_dette" id="nouvelle_vente_description" class="form-control p-2 border border-secondary" rows="1" style="border: 1px solid #ced4da;" placeholder="Description de la vente..."></textarea>
            </div>
          </div>          <!-- Sélection des articles -->
          <div class="row">
            <div class="col-12">
              <h6 class="text-dark font-weight-bolder mb-3">
                <i class="material-symbols-rounded me-2">inventory_2</i>
                Articles à ajouter
              </h6>
              
              <!-- Note d'information -->
              <div class="alert alert-info alert-dismissible text-white mb-3" role="alert">
                <span class="alert-icon align-middle">
                  <i class="material-symbols-rounded">info</i>
                </span>
                <span class="alert-text">
                  <strong>Note :</strong> Si l'école a déjà une vente pour l'année scolaire sélectionnée, les articles seront ajoutés à la vente existante. Sinon, une nouvelle vente sera créée.
                </span>
              </div>
              
              <div id="articles_container">
                <div class="article-row row mb-3">
                  <div class="col-md-6">
                    <label class="form-label">Cahier</label>
                    <select name="articles[0][cahier_id]" class="form-select border border-secondary">
                      <option value=""></option>
                      {% for cahier in cahiers %}
                        <option value="{{ cahier.id }}" data-prix="{{ cahier.prix }}">{{ cahier.titre }} - {{ cahier.prix|floatformat:0 }}F</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Quantité</label>
                    <input type="number" min="1" value="1" name="articles[0][quantite]" class="form-control border border-secondary" placeholder="1">
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-article" disabled>
                      <i class="material-symbols-rounded">remove</i>
                    </button>
                  </div>
                </div>
              </div>
              
              <button type="button" id="addArticleBtn" class="btn btn-outline-primary btn-sm">
                <i class="material-symbols-rounded me-1">add</i>
                Ajouter un article
              </button>
            </div>
          </div>

          <!-- Récapitulatif -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">Récapitulatif</h6>
                  <div class="d-flex justify-content-between">
                    <span>Montant articles:</span>
                    <span id="montant_articles">0 F</span>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span>Dette précédente:</span>
                    <span id="montant_dette">0 F</span>
                  </div>
                  <hr>
                  <div class="d-flex justify-content-between fw-bold">
                    <span>Total:</span>
                    <span id="montant_total">0 F</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">
            <i class="material-symbols-rounded me-1">save</i>
            Créer la vente
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Données des cahiers pour le JavaScript
  const cahiersData = [
    {% for cahier in cahiers %}
      {id: '{{ cahier.id }}', titre: '{{ cahier.titre }}', prix: {{ cahier.prix }}},
    {% endfor %}
  ];
  
  // Gestion du modal nouvelle vente
  document.addEventListener('DOMContentLoaded', function() {
    let articleIndex = 1; // Commence à 1 car le premier article [0] est déjà présent
    
    // Fonction pour générer les options de cahiers
    function generateCahierOptions() {
      let options = '<option value="">-- Sélectionner un cahier --</option>';
      cahiersData.forEach(cahier => {
        options += `<option value="${cahier.id}" data-prix="${cahier.prix}">${cahier.titre} - ${cahier.prix}F</option>`;
      });
      return options;
    }
    
    // Fonction pour mettre à jour le récapitulatif
    function updateRecapitulatif() {
      let montantArticles = 0;
      const rows = document.querySelectorAll('.article-row');
      
      rows.forEach(row => {
        const select = row.querySelector('select');
        const quantiteInput = row.querySelector('input[type="number"]');
        
        if (select && select.value && quantiteInput && quantiteInput.value) {
          const selectedOption = select.selectedOptions[0];
          const prix = parseFloat(selectedOption?.dataset?.prix || 0);
          const quantite = parseInt(quantiteInput.value || 0);
          if (prix > 0 && quantite > 0) {
            montantArticles += prix * quantite;
          }
        }
      });
      
      const detteInput = document.getElementById('nouvelle_vente_dette');
      const dette = parseFloat(detteInput?.value || 0);
      const total = montantArticles + dette;
      
      const montantArticlesEl = document.getElementById('montant_articles');
      const montantDetteEl = document.getElementById('montant_dette');
      const montantTotalEl = document.getElementById('montant_total');
      
      if (montantArticlesEl) montantArticlesEl.textContent = montantArticles.toFixed(0) + ' F';
      if (montantDetteEl) montantDetteEl.textContent = dette.toFixed(0) + ' F';
      if (montantTotalEl) montantTotalEl.textContent = total.toFixed(0) + ' F';
    }
    
    // Fonction pour mettre à jour les boutons de suppression
    function updateRemoveButtons() {
      const removeButtons = document.querySelectorAll('.remove-article');
      removeButtons.forEach((btn) => {
        btn.disabled = removeButtons.length <= 1;
      });
    }
    
    // Fonction pour attacher les événements à une ligne d'article
    function attachArticleEvents(row) {
      const select = row.querySelector('select');
      const quantiteInput = row.querySelector('input[type="number"]');
      const removeBtn = row.querySelector('.remove-article');
      
      if (select) {
        select.addEventListener('change', updateRecapitulatif);
      }
      
      if (quantiteInput) {
        quantiteInput.addEventListener('input', updateRecapitulatif);
      }
      
      if (removeBtn) {
        removeBtn.addEventListener('click', function() {
          row.remove();
          updateRemoveButtons();
          updateRecapitulatif();
        });
      }
    }
    
    // Initialiser les événements pour le premier article existant
    const firstArticleRow = document.querySelector('.article-row');
    if (firstArticleRow) {
      attachArticleEvents(firstArticleRow);
    }
    
    // Ajouter l'événement pour le champ dette
    const detteInput = document.getElementById('nouvelle_vente_dette');
    if (detteInput) {
      detteInput.addEventListener('input', updateRecapitulatif);
    }
    
    // Initialiser les boutons de suppression
    updateRemoveButtons();
    
    // Calculer le récapitulatif initial
    updateRecapitulatif();
    
    // Ajouter un article
    const addArticleBtn = document.getElementById('addArticleBtn');
    if (addArticleBtn) {
      addArticleBtn.addEventListener('click', function() {
        const container = document.getElementById('articles_container');
        if (!container) return;
        
        const newRow = document.createElement('div');
        newRow.className = 'article-row row mb-3';
        newRow.innerHTML = `
          <div class="col-md-6">
            <label class="form-label">Cahier</label>
            <select name="articles[${articleIndex}][cahier_id]" class="form-select border border-secondary">
              ${generateCahierOptions()}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Quantité</label>
            <input type="number" min="1" value="1" name="articles[${articleIndex}][quantite]" class="form-control border border-secondary" placeholder="1">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="button" class="btn btn-outline-danger btn-sm remove-article">
              <i class="material-symbols-rounded">remove</i>
            </button>
          </div>
        `;
        
        container.appendChild(newRow);
        articleIndex++;
        
        // Attacher les événements à la nouvelle ligne
        attachArticleEvents(newRow);
        
        updateRemoveButtons();
        updateRecapitulatif();
      });
    }
    
    // Gérer la soumission du formulaire de création de vente
    const nouvelleVenteForm = document.getElementById('formNouvelleVente');
    if (nouvelleVenteForm) {
      nouvelleVenteForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validation : au moins un article
        const rows = document.querySelectorAll('.article-row');
        let articles = [];
        
        rows.forEach(row => {
          const select = row.querySelector('select');
          const quantiteInput = row.querySelector('input[type="number"]');
          
          if (select && select.value && quantiteInput && quantiteInput.value && parseInt(quantiteInput.value) > 0) {
            articles.push({
              cahier_id: select.value,
              quantite: parseInt(quantiteInput.value)
            });
          }
        });
        
        if (articles.length === 0) {
          alert('Veuillez ajouter au moins un article avec une quantité valide.');
          return;
        }
        
        // Préparer les données du formulaire
        const formData = new FormData(nouvelleVenteForm);
        
        // Ajouter les articles en JSON
        formData.append('articles', JSON.stringify(articles));
        
        // Désactiver le bouton et afficher un indicateur de chargement
        const submitBtn = document.querySelector('#modalNouvelleVente .btn-primary');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="material-symbols-rounded">hourglass_empty</i> Création...';
        
        // Envoyer la requête
        fetch('{% url "creer_vente" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Fermer le modal
            const modalElement = document.getElementById('modalNouvelleVente');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
              modal.hide();
            }
            
            // Afficher un message de succès
            if (data.message) {
              alert(data.message);
            }
            
            // Rediriger vers la page de détail de la vente ou recharger la liste
            if (data.redirect_url) {
              window.location.href = data.redirect_url;
            } else {
              window.location.reload();
            }
          } else {
            // Afficher l'erreur
            alert('Erreur : ' + (data.error || 'Une erreur s\'est produite'));
          }
        })
        .catch(error => {
          console.error('Erreur:', error);
          alert('Erreur de communication avec le serveur');
        })
        .finally(() => {
          // Réactiver le bouton
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        });
      });
    }
    
    // Réinitialiser le modal à chaque ouverture
    const modalElement = document.getElementById('modalNouvelleVente');
    if (modalElement) {
      modalElement.addEventListener('show.bs.modal', function () {
        // Réinitialiser le formulaire
        const form = document.getElementById('formNouvelleVente');
        if (form) {
          form.reset();
        }
        
        // Réinitialiser le container d'articles avec un seul article
        const container = document.getElementById('articles_container');
        if (container) {
          container.innerHTML = `
            <div class="article-row row mb-3">
              <div class="col-md-6">
                <label class="form-label">Cahier</label>
                <select name="articles[0][cahier_id]" class="form-select border border-secondary">
                  ${generateCahierOptions()}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Quantité</label>
                <input type="number" min="1" value="1" name="articles[0][quantite]" class="form-control border border-secondary" placeholder="1">
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger btn-sm remove-article" disabled>
                  <i class="material-symbols-rounded">remove</i>
                </button>
              </div>
            </div>
          `;
          
          // Réattacher les événements au premier article
          const firstRow = container.querySelector('.article-row');
          if (firstRow) {
            attachArticleEvents(firstRow);
          }
        }
        
        // Réinitialiser l'index des articles
        articleIndex = 1;
        
        // Mettre à jour les boutons et le récapitulatif
        updateRemoveButtons();
        updateRecapitulatif();
      });
    }
  });
</script>
<script>
  var retirerModal = document.getElementById('retirerModal')
retirerModal.addEventListener('show.bs.modal', function (event) {
  var button = event.relatedTarget
  var venteId = button.getAttribute('data-vente-id')
  var form = document.getElementById('retirerModalForm')
  form.action = '/ventes/' + venteId + '/retirer/'
  var container = document.getElementById('retirer-articles-container')
  container.innerHTML = ''
  // Charger les cahiers de la vente via AJAX
  fetch('/ventes/' + venteId + '/cahiers/')
    .then(response => response.json())
    .then(data => {
      data.lignes.forEach(function(ligne, idx){
        var div = document.createElement('div')
        div.className = 'row mb-3'
        div.innerHTML = `
          <div class="col-md-6">
            <div class="input-group input-group-outline">
              <input type="text" class="form-control border border-secondary" value="${ligne.cahier_titre}" readonly />
              <input type="hidden" name="cahier_${idx}" value="${ligne.cahier_id}" />
            </div>
          </div>
          <div class="col-md-3">
            <div class="input-group input-group-outline">
              <input name="quantite_${idx}" type="number" min="0" max="${ligne.quantite}" value="0" class="form-control border border-secondary" />
            </div>
          </div>
        `
        container.appendChild(div)
      })
    })
})
</script>
{% endblock %}
